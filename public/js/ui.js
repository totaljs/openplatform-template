// Component: j-Exec
// Version: 1
// Updated: 2021-07-04 13:10
COMPONENT('exec',function(self,config){var regparent=/\?\d/;self.readonly();self.blind();self.make=function(){var scope=null,scopepath=function(el,val){if(!scope)scope=el.scope();return val==null?scope:scope?scope.makepath?scope.makepath(val):val.replace(/\?/g,el.scope().path):val};var fn=function(plus,forceprevent){return function(e){var el=$(this);var attr=el.attrd('exec'+plus);var path=el.attrd('path'+plus);var href=el.attrd('href'+plus);var def=el.attrd('def'+plus);var reset=el.attrd('reset'+plus);scope=null;var prevent=forceprevent?'1':el.attrd('prevent'+plus);if(prevent==='true'||prevent==='1'){e.preventDefault();e.stopPropagation()}if(attr){if(attr.charCodeAt(0)==='@'){attr=attr.substring(1);var com=el.component();if(com&&typeof(com[attr])==='function')com[attr](el,e);return}if(attr.indexOf('?')!==-1){var tmp=scopepath(el);if(tmp){var isparent=regparent.test(attr);attr=tmp.makepath?tmp.makepath(attr):attr.replace(/\?/g,tmp.path);if(isparent&&attr.indexOf('/')!==-1)M.scope(attr.split('/')[0]);else M.scope(tmp.path)}}EXEC(attr,el,e)}href&&NAV.redirect(href);if(def){if(def.indexOf('?')!==-1)def=scopepath(el,def);DEFAULT(def)}if(reset){if(reset.indexOf('?')!==-1)reset=scopepath(el,reset);RESET(reset)}if(path){var val=el.attrd('value');if(val){if(path.indexOf('?')!==-1)path=scopepath(el,path);var v=GET(path);SET(path,new Function('value','return '+val)(v),true)}}}};self.event('contextmenu',config.selector3||'.exec3',fn('3',true));self.event('dblclick',config.selector2||'.exec2',fn('2'));self.event('click',config.selector||'.exec',fn(''))}});
// End: j-Exec

// Component: j-Part
// Version: 1
// Updated: 2022-01-19 19:30
COMPONENT('part','hide:1;loading:1;delay:500;delayloading:800',function(self,config,cls){var init=false,clid=null,downloading=false,isresizing=false,cache={};self.releasemode&&self.releasemode('true');self.readonly();self.make=function(){self.aclass(cls)};self.resize=function(){if(config.absolute){var pos=self.element.position();var obj={};obj.width=WW-pos.left;obj.height=WH-pos.top;self.css(obj)}};var replace=function(value){return value.replace(/\?/g,config.path||config.if)};self.setter=function(value){if(cache[value]){if(downloading)return;if(config.absolute&&!isresizing){self.on('resize2',self.resize);isresizing=true}if(self.dom.hasChildNodes()){if(clid){clearTimeout(clid);clid=null}self.release(false);var done=function(){config.hide&&self.rclass('hidden');config.reload&&EXEC(replace(config.reload));config.default&&DEFAULT(replace(config.default),true);var invisible=self.hclass('invisible');invisible&&self.rclass('invisible',config.delay);isresizing&&setTimeout(self.resize,50);setTimeout(self.emitresize,200);config.autofocus&&self.autofocus(config.autofocus)};if(config.check)EXEC(replace(config.check),done);else done()}else{config.loading&&SETTER('loading/show');downloading=true;setTimeout(function(){var preparator;if(config.replace)preparator=GET(replace(config.replace));else{preparator=function(content){return content.replace(/~PATH~/g,replace(config.path||config.if)).replace(/~ID~/,config.id||'')}}self.import(replace(config.url),function(){if(!init){config.init&&EXEC(replace(config.init));init=true}var done=function(){config.hide&&self.rclass('hidden');self.release(false);config.reload&&EXEC(replace(config.reload),true);config.default&&DEFAULT(replace(config.default),true);config.loading&&SETTER('loading/hide',config.delayloading);var invisible=self.hclass('invisible');invisible&&self.rclass('invisible',config.delay);isresizing&&setTimeout(self.resize,50);setTimeout(self.emitresize,200);downloading=false;config.autofocus&&self.autofocus(config.autofocus)};EMIT('parts.'+config.if,self.element,self);if(config.check)EXEC(replace(config.check),done);else done()},true,preparator)},200)}}else{if(!self.hclass('hidden')){config.hidden&&EXEC(replace(config.hidden));config.hide&&self.aclass('hidden'+(config.invisible?' invisible':''));self.release(true)}if(config.cleaner&&init&&!clid)clid=setTimeout(self.clean,config.cleaner*60000)}};self.emitresize=function(){self.element.SETTER('*','resize')};self.configure=function(key,value){switch(key){case'if':var tmp=(value+'').split(',').trim();cache={};for(var i=0;i<tmp.length;i++)cache[tmp[i]]=1;break;case'absolute':var is=!!value;self.tclass(cls+'-absolute',is);break}};self.clean=function(){if(self.hclass('hidden')){config.clean&&EXEC(replace(config.clean));setTimeout(function(){self.empty();init=false;clid=null;setTimeout(FREE,1000)},1000)}}});
// End: j-Part

// Component: j-Selected
// Version: 1
// Updated: 2021-08-31 16:43
COMPONENT('selected','class:selected;selector:a;attr:if;attror:or;delay:50',function(self,config){self.readonly();self.refresh2=function(){self.refreshid=null;self.refresh()};self.configure=function(key,value){switch(key){case'datasource':self.datasource(value,function(){self.refreshid&&clearTimeout(self.refreshid);self.refreshid=setTimeout(self.refresh2,config.delay)});break}};self.setter=function(value){var cls=config.class;self.find(config.selector).each(function(){var el=$(this);var or=el.attrd(config.attror)||'';if(el.attrd(config.attr)===value||(or&&or.indexOf(value)!==-1))el.aclass(cls);else el.hclass(cls)&&el.rclass(cls)})}});
// End: j-Selected

// Component: Tangular-Initials
// Version: 1
// Updated: 2020-09-15 13:07
var TTIC=['#1abc9c','#2ecc71','#3498db','#9b59b6','#34495e','#16a085','#2980b9','#8e44ad','#2c3e50','#f1c40f','#e67e22','#e74c3c','#d35400','#c0392b'];Thelpers.initials=function(value){var index=value.indexOf('.');var arr=value.substring(index+1).replace(/\s{2,}/g,' ').trim().split(' ');var initials=((arr[0].substring(0,1)+(arr[1]||'').substring(0,1))).toUpperCase();var sum=0;for(var i=0;i<value.length;i++)sum+=value.charCodeAt(i);return'<span class="initials" style="background-color:{1}" title="{2}">{0}</span>'.format(initials,TTIC[sum%TTIC.length],value)};Thelpers.initialsbase64=function(value,width,height){var index=value.indexOf('.');var arr=value.substring(index+1).replace(/\s{2,}/g,' ').trim().split(' ');var initials=((arr[0].substring(0,1)+(arr[1]||'').substring(0,1))).toUpperCase();var sum=0;for(var i=0;i<value.length;i++)sum+=value.charCodeAt(i);var canvas=W.$initialscanvas;if(!canvas)canvas=W.$initialscanvas=document.createElement('CANVAS');if(canvas.width!=width)canvas.width=width;if(canvas.height!=height)canvas.height=height;var color=TTIC[sum%TTIC.length],ctx=canvas.getContext('2d');ctx.fillStyle=color;ctx.fillRect(0,0,width,height);ctx.font='bold '+((width/2)>>0)+'px Arial';ctx.fillStyle='#FFFFFF';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(initials,(width/2),(height/2>>0)+5);return canvas.toDataURL('image/png')};
// End: Tangular-Initials

// Component: j-Breadcrumb
// Version: 1
// Updated: 2021-08-10 12:35
COMPONENT('breadcrumb','icon:fa fa-home;historyapi:1;root:Root',function(self,config,cls){var nav;self.make=function(){self.aclass(cls+(config.style===2?(' '+cls+'-style2'):''));self.element.prepend('<nav></nav>');nav=self.find('> nav');nav.on('click','a,span',function(e){e.preventDefault();var el=$(this);var url=el.attrd('id')||el.attr('href');var items=self.get();var item=items.findItem('url',url);if(item&&item.callback){item.callback(el,e);return}if(config.exec){self.SEEX(config.exec,url,el);return}if(config.historyapi)REDIRECT(url);else location.href=url})};self.add=function(name,url,callback){var arr=[];config.root&&arr.push({name:config.root,url:'/'});var fn=function(name,url,callback){if(name&&url)arr.push({name:name,url:url,callback:callback});return fn};setTimeout(function(){self.set(arr)},1);return fn(name,url,callback)};self.setter=function(value,path,type){if(!value)value=EMPTYARRAY;var builder=[];for(var i=0;i<value.length;i++){var item=value[i];builder.push('<{0}="{1}"{4}>{2}</{3}>'.format(config.exec?'span data-id':'a href',item.url||item.id,Thelpers.encode(item.name),config.exec?'span':'a',item.callback?' class="{0}-children"'.format(cls):''))}var html=builder.join('<i class="fa fa-angle-right"></i>');if(config.icon&&html)html='<i class="{0}"></i>'.format(config.icon)+html;nav.html(html);if(!type)self.rclass('hidden invisible')}});
// End: j-Breadcrumb

// Component: j-VirtualWire
// Version: 1
// Updated: 2021-05-14 12:33
COMPONENT('virtualwire','selector:.virtualwire',function(self,config){var old,waiter;self.restore=function(){if(old){while(self.dom.children.length)old[0].appendChild(self.dom.children[0]);var exec=old.attrd('out');exec&&EXEC(exec);old=null}};self.backup=function(el){if(!el||!el.length){self.restore();return}if(old&&old[0]===el[0])return;self.restore();var children=el[0].children;while(children.length)self.dom.appendChild(children[0]);old=el;var exec=el.attrd('in');exec&&EXEC(exec)};self.load=function(value){waiter&&clearTimeout(waiter);waiter=null;var el=$(config.selector+'[data-if="'+value+'"]');if(el.length)self.backup(el);else{el=$(config.selector+'[data-scope="'+value+'"]');if(el.length)self.backup(el);else waiter=setTimeout(self.load,100,value)}};self.setter=function(value){self.restore();if(!value)return;waiter&&clearTimeout(waiter);self.load(value)}});
// End: j-VirtualWire

// Component: j-SearchInput
// Version: 1
// Updated: 2021-04-20 16:01
COMPONENT('searchinput','searchicon:fa fa-search;cancelicon:fa fa-times;align:left',function(self,config,cls){var input,icon,prev,prev2;self.novalidate();self.make=function(){self.aclass(cls+' '+cls+'-'+config.align);self.html('<span><i class="{0}"></i></span><div><input type="text" autocomplete="new-password" maxlength="100" placeholder="{1}" data-jc-bind /></div>'.format(config.searchicon,config.placeholder));input=self.find('input')[0];icon=self.find('i');self.event('click','span',function(){prev&&self.set('');prev2=''});config.autofocus&&self.autofocus()};self.focus=function(){input&&input.focus()};self.check=function(){var is=!!input.value.trim();if(is!==prev){icon.rclass().aclass(is?config.cancelicon:config.searchicon);prev=is;self.tclass(cls+'-is',is)}};self.clear=function(){input.value='';config.exec&&self.SEEX(config.exec,input.value,self.element);self.check()};self.setter=function(value,path,type){input.value=value||'';if(prev2!==input.value){prev2=input.value;type&&config.exec&&self.SEEX(config.exec,input.value,self.element)}self.check()}});
// End: j-SearchInput

// Component: j-ViewBox
// Version: 1
// Updated: 2021-12-08 15:05
COMPONENT('viewbox','margin:0;scroll:true;delay:100;initdelay:250;scrollbar:0;visibleY:1;height:100;invisible:1',function(self,config,cls){var eld,elb,scrollbar,cls2='.'+cls,init=false,cache,scrolltoforce;self.readonly();self.init=function(){var resize=function(){for(var i=0;i<M.components.length;i++){var com=M.components[i];if(com.name==='viewbox'&&com.dom.offsetParent&&com.$ready&&!com.$removed)com.resizeforce()}};ON('resize2',function(){setTimeout2('viewboxresize',resize,200)})};self.destroy=function(){scrollbar&&scrollbar.destroy()};self.configure=function(key,value,init){switch(key){case'disabled':eld.tclass('hidden',!value);break;case'minheight':case'margin':case'marginxs':case'marginsm':case'marginmd':case'marginlg':!init&&self.resizeforce();break;case'selector':config.parent=value;self.resize();break}};self.scrollbottom=function(val){if(val==null)return elb[0].scrollTop;elb[0].scrollTop=(elb[0].scrollHeight-self.dom.clientHeight)-(val||0);return elb[0].scrollTop};self.scrolltop=function(val){if(val==null)return elb[0].scrollTop;elb[0].scrollTop=(val||0);return elb[0].scrollTop};self.make=function(){var centered='';if(config.centered)centered='<div class="{0}-centered-table"><div class="{0}-centered-cell"></div></div>'.format(cls);config.invisible&&self.aclass('invisible');config.scroll&&MAIN.version>17&&self.element.wrapInner('<div class="'+cls+'-body">'+centered+'</div>');self.element.prepend('<div class="'+cls+'-disabled hidden"></div>');eld=self.find('> .{0}-disabled'.format(cls)).eq(0);elb=self.find('> .{0}-body'.format(cls)).eq(0);self.aclass('{0} {0}-hidden'.format(cls));if(config.scroll){if(config.scrollbar){if(MAIN.version>17){scrollbar=W.SCROLLBAR(self.find(cls2+'-body'),{shadow:config.scrollbarshadow,visibleY:config.visibleY,visibleX:config.visibleX,orientation:config.visibleX?null:'y',parent:self.element});self.scrolltop=scrollbar.scrollTop;self.scrollbottom=scrollbar.scrollBottom}else self.aclass(cls+'-scroll')}else{self.aclass(cls+'-scroll');if(M.version<19)self.find(cls2+'-body').aclass('noscrollbar')}}self.resize()};self.released=function(is){!is&&self.resize()};var css={};self.resize=function(){setTimeout2(self.ID,self.resizeforce,200)};self.resizeforce=function(){var el=self.parent(config.parent);var h=el.height();var w=el.width();var width=WIDTH();var mywidth=self.element.width();var key=width+'x'+mywidth+'x'+w+'x'+h+'x'+config.margin;if(cache===key){scrollbar&&scrollbar.resize();if(scrolltoforce){if(scrolltoforce==='bottom')self.scrollbottom(0);else self.scrolltop(0);scrolltoforce=null}return}cache=key;var margin=config.margin,responsivemargin=config['margin'+width];if(responsivemargin!=null)margin=responsivemargin;if(margin==='auto')margin=self.element.offset().top;if(h===0||w===0){self.$waiting&&clearTimeout(self.$waiting);self.$waiting=setTimeout(self.resize,234);return}h=((h/100)*config.height)-margin;if(config.minheight&&h<config.minheight)h=config.minheight;if(config.centered)elb.find(cls2+'-centered-table').css('min-height',h);css.height=h;css.width=mywidth;eld.css(css);css.width='';self.css(css);elb.length&&elb.css(css);self.element.SETTER('*','resize');var c=cls+'-hidden';self.hclass(c)&&self.rclass(c,100);scrollbar&&scrollbar.resize();if(scrolltoforce){if(scrolltoforce==='bottom')self.scrollbottom(0);else self.scrolltop(0);scrolltoforce=null}if(!init){self.rclass('invisible',config.initdelay);init=true}};self.resizescrollbar=function(){scrollbar&&scrollbar.resize()};self.setter=function(){scrolltoforce=config.scrollto||config.scrolltop;if(scrolltoforce){if(scrolltoforce==='bottom')self.scrollbottom(0);else self.scrolltop(0);scrolltoforce=null}setTimeout(self.resize,config.delay,scrolltoforce)}});
// End: j-ViewBox

// Component: j-Search
// Version: 1
// Updated: 2021-11-17 12:35
COMPONENT('search','class:hidden;delay:50;attribute:data-search;splitwords:1;delaydatasource:100',function(self,config,cls){self.readonly();self.make=function(){config.datasource&&self.datasource(config.datasource,function(){setTimeout(function(){self.refresh()},config.delaydatasource)})};self.search=function(){var value=self.get();var elements=self.find(config.selector);var length=elements.length;if(!value){elements.rclass(config.class);self.rclass2(cls+'-');config.exec&&self.SEEX(config.exec,{hidden:0,count:length,total:length,search:'',is:false});return}var search=value.toSearch();var count=0,hidden=0,custom=config.custom?GET(self.makepath(config.custom)):null;if(config.splitwords)search=search.split(' ');self.aclass(cls+'-used');for(var i=0;i<length;i++){var el=elements.eq(i);var is=false;if(custom){is=!custom(el,search);el.tclass(config.class,is);if(is)hidden++;else count++;continue}var val=(el.attr(config.attribute)||'').toSearch();if(search instanceof Array){for(var j=0;j<search.length;j++){if(val.indexOf(search[j])===-1){is=true;break}}}else is=val.indexOf(search)===-1;el.tclass(config.class,is);if(is)hidden++;else count++}self.tclass(cls+'-empty',!count);config.exec&&self.SEEX(config.exec,{total:length,hidden:hidden,count:count,search:search,is:true})};self.setter=function(value){if(!config.selector||!config.attribute||value==null)return;setTimeout2('search'+self.ID,self.search,config.delay)}});
// End: j-Search

// Component: j-Importer
// Version: 1
// Updated: 2021-03-29 11:15
COMPONENT('importer',function(self,config){var init=false,clid=null,pending=false,content='',replace=function(value){return self.scope?self.makepath(value):value.replace(/\?/g,config.path||config.if)};var replace2=function(value){return value?value.replace(/~PATH~/g,config.path||config.if):value};self.readonly();self.make=function(){var scr=self.find('script');content=scr.length?scr.html():''};self.reload=function(recompile){config.reload&&EXEC(replace(config.reload));recompile&&COMPILE();setTimeout(function(){pending=false;init=true},1000)};self.setter=function(value){if(pending)return;if(config.if!==value){if(config.cleaner&&init&&!clid)clid=setTimeout(self.clean,config.cleaner*60000);return}pending=true;if(clid){clearTimeout(clid);clid=null}if(init){self.reload();return}if(content){self.html(replace2(content));setTimeout(self.reload,50,true)}else self.import(config.url,self.reload,true,replace2)};self.clean=function(){config.clean&&EXEC(replace(config.clean));setTimeout(function(){self.empty();init=false;clid=null},1000)}});
// End: j-Importer

// Component: j-Validate
// Version: 1
// Updated: 2021-11-13 16:48
COMPONENT('validate','delay:100;flags:visible',function(self,config,cls){var elements=null,def='button[name="submit"]',flags=null,tracked=false,reset=0,old,track;self.readonly();self.make=function(){elements=self.find(config.selector||def)};self.configure=function(key,value,init){switch(key){case'selector':if(!init)elements=self.find(value||def);break;case'flags':if(value){flags=value.split(',');for(var i=0;i<flags.length;i++)flags[i]='@'+flags[i]}else flags=null;break;case'track':track=value.split(',').trim();break}};var settracked=function(){tracked=0};self.setter=function(value,path,type){var is=path===self.path||path.length<self.path.length;if(reset!==is){reset=is;self.tclass(cls+'-modified',!reset)}if((type===1||type===2)&&track&&track.length){for(var i=0;i<track.length;i++){if(path.indexOf(track[i])!==-1){tracked=1;return}}if(tracked===1){tracked=2;setTimeout(settracked,config.delay*3)}}};var check=function(){var path=self.path.replace(/\.\*$/,'');var disabled=tracked||config.validonly?!VALID(path,flags):DISABLED(path,flags);if(!disabled&&config.if)disabled=!EVALUATE(path,config.if);if(disabled!==old){elements.prop('disabled',disabled);self.tclass(cls+'-ok',!disabled);self.tclass(cls+'-no',disabled);old=disabled}};self.state=function(type,what){if(type===3||what===3){self.rclass(cls+'-modified');tracked=0}setTimeout2(self.ID,check,config.delay)}});
// End: j-Validate

// Component: j-Input
// Version: 1
// Updated: 2021-12-07 10:16
COMPONENT('input','maxlength:200;dirkey:name;dirvalue:id;increment:1;autovalue:name;direxclude:false;checkicon:fa fa-check;forcevalidation:1;searchalign:1;height:80;after:\\:',function(self,config,cls){var cls2='.'+cls,input,placeholder,dirsource,binded,customvalidator,mask,rawvalue,isdirvisible=false,nobindcamouflage=false,focused=false;self.nocompile();self.init=function(){Thelpers.ui_input_icon=function(val){return val.charAt(0)==='!'||val.indexOf(' ')!==-1?('<span class="ui-input-icon-custom">'+(val.charAt(0)==='!'?val.substring(1):('<i class="'+val)+'"></i>')+'</span>'):('<i class="fa fa-'+val+'"></i>')};W.ui_input_template=Tangular.compile(('{{ if label}}<div class="{0}-label">{{ if icon}}<i class="{{ icon}}"></i>{{ fi}}{{ label | raw}}{{ after | raw}}</div>{{ fi}}<div class="{0}-control{{ if licon}} {0}-licon{{ fi}}{{ if ricon || (type === \'number\' && increment) }} {0}-ricon{{ fi}}">{{ if ricon || (type === \'number\' && increment) }}<div class="{0}-icon-right{{ if type === \'number\' && increment && !ricon}} {0}-increment{{ else if riconclick || type === \'date\' || type === \'time\' || (type === \'search\' && searchalign === 1) || type === \'password\' }} {0}-click{{ fi}}">{{ if type === \'number\' && !ricon}}<i class="fa fa-caret-up"></i><i class="fa fa-caret-down"></i>{{ else}}{{ ricon | ui_input_icon}}{{ fi}}</div>{{ fi}}{{ if licon}}<div class="{0}-icon-left{{ if liconclick || (type === \'search\' && searchalign !== 1) }} {0}-click{{ fi}}">{{ licon | ui_input_icon}}</div>{{ fi}}<div class="{0}-input{{ if align === 1 || align === \'center\' }} center{{ else if align === 2 || align === \'right\' }} right{{ fi}}">{{ if placeholder && !innerlabel}}<div class="{0}-placeholder">{{ placeholder}}</div>{{ fi}}{{ if dirsource || type === \'icon\' || type === \'emoji\' || type === \'color\' }}<div class="{0}-value" tabindex="0"></div>{{ else}}{{ if type === \'multiline\' }}<textarea data-jc-bind="" style="height:{{ height}}px"></textarea>{{ else}}<input type="{{ if type === \'password\' }}password{{ else}}text{{ fi}}"{{ if autofill}} autocomplete="on" name="{{ PATH}}"{{ else}} name="input'+Date.now()+'" autocomplete="new-password"{{ fi}} data-jc-bind=""{{ if maxlength > 0}} maxlength="{{ maxlength}}"{{ fi}}{{ if autofocus}} autofocus{{ fi}} />{{ fi}}{{ fi}}</div></div>{{ if error}}<div class="{0}-error hidden"><i class="fa fa-warning"></i> {{ error}}</div>{{ fi}}').format(cls))};self.make=function(){if(!config.label)config.label=self.html();if(isMOBILE&&config.autofocus)config.autofocus=false;config.PATH=self.path.replace(/\./g,'_');self.aclass(cls+' invisible');self.rclass('invisible',100);self.redraw();self.event('input change',function(){if(nobindcamouflage)nobindcamouflage=false;else self.check()});self.event('click',cls2+'-checkbox',function(){if(config.disabled){$(this).blur();return}self.change(true);var val=self.get();if(val===1)val=0;else if(val===0)val=1;else if(val===true)val=false;else val=true;self.set(val,2)});self.event('focus','input,'+cls2+'-value',function(){if(config.disabled){$(this).blur();return}focused=true;self.camouflage(false);self.aclass(cls+'-focused');config.autocomplete&&EXEC(self.makepath(config.autocomplete),self,input.parent());if(config.autosource){var opt={};opt.element=self.element;opt.search=GET(self.makepath(config.autosource));opt.callback=function(value){var val=typeof(value)==='string'?value:value[config.autovalue];if(config.autoexec){EXEC(self.makepath(config.autoexec),value,function(val){self.set(val,2);self.change();self.bindvalue()})}else{self.set(val,2);self.change();self.bindvalue()}};SETTER('autocomplete','show',opt)}else if(config.mask){setTimeout(function(input){input.selectionStart=input.selectionEnd=0},50,this)}else if(config.dirsource&&(config.autofocus!=false&&config.autofocus!=0)){if(!isdirvisible)self.find(cls2+'-control').trigger('click')}else if(config.type==='date'||config.type==='time'){setTimeout(function(){self.element.find(cls2+'-icon-right').trigger('click')},300)}});self.event('paste','input',function(e){if(config.mask){var val=(e.originalEvent.clipboardData||window.clipboardData).getData('text');self.set(val.replace(/\s|\t/g,''));e.preventDefault()}self.check()});self.event('keydown','input',function(e){var t=this,code=e.which;if(t.readOnly||config.disabled){if(e.keyCode!==9){if(config.dirsource){self.find(cls2+'-control').trigger('click');return}e.preventDefault();e.stopPropagation()}return}if(!config.disabled&&config.dirsource&&(code===13||code>30)){self.find(cls2+'-control').trigger('click');return}if(config.mask){if(e.metaKey){if(code===8||code===127){e.preventDefault();e.stopPropagation()}return}if(code===32){e.preventDefault();e.stopPropagation();return}var beg=e.target.selectionStart,end=e.target.selectionEnd,val=t.value,c;if(code===8||code===127){if(beg===end){c=config.mask.substring(beg-1,beg);t.value=val.substring(0,beg-1)+c+val.substring(beg);self.curpos(beg-1)}else{for(var i=beg;i<=end;i++){c=config.mask.substring(i-1,i);val=val.substring(0,i-1)+c+val.substring(i)}t.value=val;self.curpos(beg)}e.preventDefault();return}if(code>40){var cur=String.fromCharCode(code);if(mask&&mask[beg]){if(!mask[beg].test(cur)){e.preventDefault();return}}c=config.mask.charCodeAt(beg);if(c!==95){beg++;while(true){c=config.mask.charCodeAt(beg);if(c===95||isNaN(c))break;else beg++}}if(c===95){val=val.substring(0,beg)+cur+val.substring(beg+1);t.value=val;beg++;while(beg<config.mask.length){c=config.mask.charCodeAt(beg);if(c===95)break;else beg++}self.curpos(beg)}else self.curpos(beg+1);e.preventDefault();e.stopPropagation()}}});self.event('blur','input,'+cls2+'-value',function(){focused=false;self.camouflage(true);self.rclass(cls+'-focused')});self.event('click',cls2+'-control',function(){if(config.disabled||isdirvisible)return;if(config.type==='icon'){opt={};opt.element=self.element;opt.value=self.get();opt.empty=true;opt.callback=function(val){self.change(true);self.set(val,2);self.check();rawvalue[0].focus()};SETTER('faicons','show',opt);return}else if(config.type==='color'){opt={};opt.element=self.element;opt.value=self.get();opt.empty=true;opt.callback=function(al){self.change(true);self.set(al,2);self.check();rawvalue[0].focus()};SETTER('colorpicker','show',opt);return}else if(config.type==='emoji'){opt={};opt.element=self.element;opt.value=self.get();opt.empty=true;opt.callback=function(al){self.change(true);self.set(al,2);self.check();rawvalue[0].focus()};SETTER('emoji','show',opt);return}if(!config.dirsource)return;isdirvisible=true;setTimeout(function(){isdirvisible=false},500);var opt={};opt.element=self.find(cls2+'-control');opt.items=dirsource||GET(self.makepath(config.dirsource));opt.offsetY=-1+(config.diroffsety||0);opt.offsetX=0+(config.diroffsetx||0);opt.placeholder=config.dirplaceholder;opt.render=config.dirrender?GET(self.makepath(config.dirrender)):null;opt.custom=!!config.dircustom;opt.offsetWidth=2;opt.minwidth=config.dirminwidth||200;opt.maxwidth=config.dirmaxwidth;opt.key=config.dirkey||config.key;opt.empty=config.dirempty;opt.checkbox=!!config.multiple;var val=self.get();if(config.multiple){for(var i=0;i<opt.items.length;i++){var item=opt.items[i];if(val instanceof Array){item.selectedts=val.indexOf(item[config.dirvalue||config.value]);item.selected=item.selectedts!==-1}else item.selected=false}}else opt.selected=val;if(config.dirraw)opt.raw=true;if(config.dirsearch!=null)opt.search=config.dirsearch;if(dirsource&&config.direxclude==false&&!config.multiple){for(var i=0;i<dirsource.length;i++){var item=dirsource[i];if(item)item.selected=typeof(item)==='object'&&item[config.dirvalue]===val}}else if(config.direxclude){opt.exclude=function(item){return item?item[config.dirvalue]===val:false}}opt.callback=function(item,el,custom){if(item==null||(config.multiple&&!item.length)){rawvalue.html('');self.set(config.multiple?[]:null,2);self.change();self.check();return}if(config.multiple){var arr=[];for(var i=0;i<item.length;i++){var m=item[i];arr.push(m[config.dirvalue||config.value])}self.set(arr,2);self.change(true);return}var val=custom||typeof(item)==='string'?item:item[config.dirvalue||config.value];if(custom&&typeof(config.dircustom)==='string'){var fn=GET(config.dircustom);fn(val,function(val){self.set(val,2);self.change(true);self.bindvalue()})}else if(custom){if(val){self.set(val,2);self.change(true);if(dirsource)self.bindvalue();else input.val(val)}}else{self.set(val,2);self.change(true);if(dirsource)self.bindvalue();else input.val(val)}rawvalue[0].focus()};SETTER('directory','show',opt)});self.event('click',cls2+'-placeholder,'+cls2+'-label',function(e){if(!config.disabled){if(config.dirsource){e.preventDefault();e.stopPropagation();self.find(cls2+'-control').trigger('click')}else if(!config.camouflage||$(e.target).hclass(cls+'-placeholder')){if(input.length){input[0].focus()}else rawvalue[0].focus()}}});self.event('click',cls2+'-icon-left,'+cls2+'-icon-right',function(e){if(config.disabled)return;var el=$(this);var left=el.hclass(cls+'-icon-left');var opt;if(config.dirsource&&left&&config.liconclick){e.preventDefault();e.stopPropagation()}if(!left&&!config.riconclick){if(config.type==='date'){opt={};opt.element=self.element;opt.value=self.get();opt.callback=function(val){self.change(true);self.set(val)};SETTER('datepicker','show',opt)}else if(config.type==='time'){opt={};opt.element=self.element;opt.value=self.get();opt.callback=function(val){self.change(true);self.set(val)};SETTER('timepicker','show',opt)}else if(config.type==='search')self.set('');else if(config.type==='password')self.password();else if(config.type==='number'||config.type==='number2'){var tmp=$(e.target);if(tmp.attr('class').indexOf('fa-')!==-1){var n=tmp.hclass('fa-caret-up')?1:-1;self.change(true);var val=self.preparevalue((self.get()||0)+(config.increment*n));self.set(val,2)}}return}if(left&&config.liconclick)EXEC(self.makepath(config.liconclick),self,el);else if(config.riconclick)EXEC(self.makepath(config.riconclick),self,el);else if(left&&config.type==='search')self.set('')})};self.camouflage=function(is){if(config.camouflage){if(is){var t=input[0],arr=t.value.split('');for(var i=0;i<arr.length;i++)arr[i]=typeof(config.camouflage)==='string'?config.camouflage:'•';nobindcamouflage=true;t.value=arr.join('')}else{nobindcamouflage=true;var val=self.get();input[0].value=val==null?'':val}self.tclass(cls+'-camouflaged',is)}};self.curpos=function(pos){var el=input[0];if(el.createTextRange){var range=el.createTextRange();range.move('character',pos);range.select()}else if(el.selectionStart){el.focus();el.setSelectionRange(pos,pos)}};self.validate=function(value){if((!config.required||config.disabled)&&!self.forcedvalidation())return true;if(config.disabled)return true;if(config.dirsource)return!!value;if(customvalidator)return customvalidator(value);if(config.type==='date')return value instanceof Date&&!isNaN(value.getTime());if(config.type==='checkbox')return value===true||value===1;if(value==null)value='';else value=value.toString();if(config.mask&&typeof(value)==='string'&&value.indexOf('_')!==-1)return false;if(config.minlength&&value.length<config.minlength)return false;switch(config.type){case'email':return value.isEmail();case'phone':return value.isPhone();case'url':return value.isURL();case'zip':return(/^\d{5}(?:[-\s]\d{4})?$/).test(value);case'currency':case'number':case'number2':if(config.type==='number2'&&(value==null||value==''))return false;value=value.parseFloat();if((config.minvalue!=null&&value<config.minvalue)||(config.maxvalue!=null&&value>config.maxvalue))return false;return config.minvalue==null?value>0:true}return value.length>0};self.offset=function(){var offset=self.element.offset();var control=self.find(cls2+'-control');var width=control.width()+2;return{left:offset.left,top:control.offset().top+control.height(),width:width}};self.password=function(show){var visible=show==null?input.attr('type')==='text':show;input.attr('type',visible?'password':'text');self.find(cls2+'-icon-right').find('i').tclass(config.ricon,visible).tclass('fa-eye-slash',!visible)};self.preparevalue=function(value){if(config.type==='number'&&(config.type!=='number2'||value)&&(config.minvalue!=null||config.maxvalue!=null)){var tmp=typeof(value)==='string'?+value.replace(',','.'):value;if(config.minvalue>tmp)value=config.minvalue;if(config.maxvalue<tmp)value=config.maxvalue}return value};self.getterin=self.getter;self.getter=function(value,realtime,nobind){if(nobindcamouflage)return;if(config.mask&&config.masktidy){var val=[];for(var i=0;i<value.length;i++){if(config.mask.charAt(i)==='_')val.push(value.charAt(i))}value=val.join('')}self.getterin(self.preparevalue(value),realtime,nobind)};self.setterin=self.setter;self.setter=function(value,path,type){if(config.mask){if(value){if(config.masktidy){var index=0,val=[];for(var i=0;i<config.mask.length;i++){var c=config.mask.charAt(i);val.push(c==='_'?(value.charAt(index++)||'_'):c)}value=val.join('')}if(mask){var arr=[];for(var i=0;i<mask.length;i++){var c=value.charAt(i);if(mask[i]&&mask[i].test(c))arr.push(c);else arr.push(config.mask.charAt(i))}value=arr.join('')}}else value=config.mask}self.setterin(value,path,type);self.bindvalue();config.camouflage&&!focused&&setTimeout(self.camouflage,type==='show'?2000:1,true);if(config.type==='password')self.password(true)};self.check=function(){var is=false;if(config.dirsource)is=!!rawvalue.text();else is=input&&input.length?!!input[0].value:!!self.get();if(binded===is)return;binded=is;placeholder&&placeholder.tclass('hidden',is);self.tclass(cls+'-binded',is);if(config.type==='search')self.find(cls2+'-icon-'+(config.searchalign===1?'right':'left')).find('i').tclass(config.searchalign===1?config.ricon:config.licon,!is).tclass('fa-times',is)};self.bindvalue=function(){var value=self.get();if(dirsource){var item,text=[];for(var i=0;i<dirsource.length;i++){item=dirsource[i];if(typeof(item)==='string'){if(item===value)break;item=null}else if(config.multiple){var v=item[config.dirvalue||config.value],index=value instanceof Array?value.indexOf(v):-1;if(index!==-1)text.push({index:index,value:item[config.dirkey||config.key]})}else if(item[config.dirvalue||config.value]===value){item=item[config.dirkey||config.key];break}else item=null}if(config.multiple){text.quicksort('index');for(var i=0;i<text.length;i++)text[i]=text[i].value;item=text.join(', ')}else if(value&&item==null&&config.dircustom)item=value;if(config.dirraw)rawvalue.html(item||'');else rawvalue.text(item||'')}else if(config.dirsource){if(config.dirdetail){self.EXEC(config.dirdetail,value,function(val){if(config.dirraw)rawvalue.html(val||'');else rawvalue.text(val||'');self.check()});return}else if(config.dirraw)rawvalue.html(value||'');else rawvalue.text(value||'')}else{switch(config.type){case'color':rawvalue.css('background-color',value||'');break;case'icon':rawvalue.html('<i class="{0}"></i>'.format(value||''));break;case'emoji':rawvalue.html(value);break;case'checkbox':self.tclass(cls+'-checked',value===true||value===1);break}}self.check()};self.redraw=function(){if(!config.ricon){if(config.dirsource)config.ricon='angle-down';else if(config.type==='date'){config.ricon='calendar';if(!config.align&&!config.innerlabel)config.align=1}else if(config.type==='icon'||config.type==='color'||config.type==='emoji'){config.ricon='angle-down';if(!config.align&&!config.innerlabel)config.align=1}else if(config.type==='time'){config.ricon='clock-o';if(!config.align&&!config.innerlabel)config.align=1}else if(config.type==='search')if(config.searchalign===1)config.ricon='search';else config.licon='search';else if(config.type==='password')config.ricon='eye';else if(config.type==='number'||config.type==='number2'){if(!config.align&&!config.innerlabel)config.align=1}}self.tclass(cls+'-masked',!!config.mask);self.rclass2(cls+'-type-');if(config.type)self.aclass(cls+'-type-'+config.type);var html,is=false;if(config.type==='checkbox'){html='<div class="{0}-checkbox"><span><i class="{checkicon}"></i></span><label>{label}</label></div>'.format(cls).arg(config)}else{is=true;var opt=CLONE(config);if(opt.type==='number2')opt.type='number';html=W.ui_input_template(opt)}self.html(html);if(is){input=self.find('input,textarea');rawvalue=self.find(cls2+'-value');placeholder=self.find(cls2+'-placeholder')}else input=rawvalue=placeholder=null};self.configure=function(key,value){switch(key){case'icon':if(value&&value.indexOf(' ')===-1)config.icon='fa fa-'+value;break;case'dirsource':if(config.dirajax||value.indexOf('/')!==-1){dirsource=null;self.bindvalue()}else{if(value.indexOf(',')!==-1){dirsource=self.parsesource(value);self.bindvalue()}else{self.datasource(value,function(path,value){dirsource=value;self.bindvalue()})}}self.tclass(cls+'-dropdown',!!value);input.prop('readonly',!!config.disabled||!!config.dirsource);break;case'disabled':self.tclass('ui-disabled',!!value);input&&input.prop('readonly',!!value||!!config.dirsource);self.reset();break;case'required':self.tclass(cls+'-required',!!value);self.reset();break;case'type':self.type=value;break;case'validate':customvalidator=value?(/\(|=|>|<|\+|-|\)/).test(value)?FN('value=>'+value):(function(path){path=self.makepath(path);return function(value){return GET(path)(value)}})(value):null;break;case'innerlabel':self.tclass(cls+'-inner',!!value);break;case'monospace':self.tclass(cls+'-monospace',!!value);break;case'maskregexp':if(value){mask=value.toLowerCase().split(',');for(var i=0;i<mask.length;i++){var m=mask[i];if(!m||m==='null')mask[i]='';else mask[i]=new RegExp(m)}}else mask=null;break;case'mask':config.mask=value.replace(/#/g,'_');break}};self.formatter(function(path,value){if(value){switch(config.type){case'lower':return(value+'').toLowerCase();case'upper':return(value+'').toUpperCase();case'phone':return(value+'').replace(/\s/g,'');case'email':return(value+'').toLowerCase();case'date':return value.format(config.format||DEF.dateformat||'yyyy-MM-dd');case'time':return value.format(config.format||'HH:mm');case'number':return config.format?value.format(config.format):value;case'number2':return value==null?'':config.format?value.format(config.format):value}}return value});self.parser(function(path,value){if(value){var tmp;switch(config.type){case'date':tmp=self.get();if(tmp)tmp=tmp.format('HH:mm');else tmp='';return value+(tmp?(' '+tmp):'');case'lower':case'email':value=value.toLowerCase();break;case'upper':value=value.toUpperCase();break;case'phone':value=value.replace(/\s/g,'');break;case'number2':if(value){var type=typeof(value);if(type==='string'&&(/^[\-0-9\.\,]+$/).test(value))value=value.parseFloat();else if(type!=='number')value=null}else value=null;break;case'time':tmp=value.split(':');var dt=self.get();value=dt?new Date(dt.getTime()):new Date();value.setHours((tmp[0]||'0').parseInt());value.setMinutes((tmp[1]||'0').parseInt());value.setSeconds((tmp[2]||'0').parseInt());break}}else{switch(config.type){case'number':value=0;break;case'number2':case'date':value=null;break}}return value?config.spaces===false?value.replace(/\s/g,''):value:value});self.state=function(type,what){if(type){if(type===1&&what===4){self.rclass(cls+'-ok '+cls+'-invalid');self.$oldstate=null;return}var invalid=config.required?self.isInvalid():self.forcedvalidation()?self.isInvalid():false;if(invalid!==self.$oldstate){self.$oldstate=invalid;self.tclass(cls+'-invalid',invalid);self.tclass(cls+'-ok',!invalid);config.error&&self.find(cls2+'-error').tclass('hidden',!invalid)}}};self.forcedvalidation=function(){if(!config.forcevalidation)return false;if(config.type==='number'||config.type==='number2')return false;var val=self.get();if(config.type==='checkbox')return val===true||val===1;return(config.type==='phone'||config.type==='email')&&(val!=null&&(typeof(val)==='string'&&val.length!==0))}});
// End: j-Input

// Component: j-Selection
// Version: 1
// Updated: 2021-08-03 16:38
COMPONENT('selection','remember:1;key:id;class:selected;selector:.selection;attr:id;event:click;dblclickselectall:1',function(self,config,cls){var skip=false;self.make=function(){self.aclass(cls);self.event(config.event,config.selector,function(e){e.preventDefault();e.stopPropagation();self.toggle($(this))});if(config.dblclickselectall){self.event('dblclick',config.selector,function(){self.selecttoggle()})}config.cancel&&self.watch(self.makepath(config.cancel),self.selectnone)};self.selectall=function(){var arr=self.find(config.selector);var sel=[];for(var i=0;i<arr.length;i++){var el=$(arr[i]);sel.push(el.attrd(config.attr));el.aclass(config.class)}skip=true;self.set(sel)};self.selectnone=function(){var model=self.get();if(model&&model.length){var arr=self.find(config.selector);for(var i=0;i<arr.length;i++){var el=$(arr[i]);el.rclass(config.class)}skip=true;self.set([])}};self.selecttoggle=function(){var arr=self.find(config.selector);var sel=[];for(var i=0;i<arr.length;i++){var el=$(arr[i]);if(el.hclass(config.class)){el.rclass(config.class)}else{sel.push(el.attrd(config.attr));el.aclass(config.class)}}skip=true;self.set(sel)};self.toggle=function(id){if(id instanceof jQuery)id=id.attrd(config.attr);var model=self.get();var added=false;if(model==null){model=[id];added=true;self.rewrite(model)}else{var index=model.indexOf(id);if(index===-1){model.push(id);added=true}else model.splice(index,1)}var el=self.find(config.selector+'[data-{0}="{1}"]'.format(config.attr,id));skip=true;el.tclass(config.class,added);self.update(true)};self.recalc=function(){var arr=self.find(config.selector);var model=self.get()||EMPTYARRAY;for(var i=0;i<arr.length;i++){var el=$(arr[i]);el.tclass(config.class,model.indexOf(el.attrd(config.attr))!==-1)}};var datasource=function(path,value){if(!config.remember){self.set([]);return}if(!value)value=EMPTYARRAY;var model=self.get()||EMPTYARRAY;var rem=[];for(var i=0;i<model.length;i++){var item=value.findItem(config.key,model[i]);if(!item)rem.push(model[i])}for(var i=0;i<rem.length;i++)model.splice(model.indexOf(rem[i]),1);self.update()};self.configure=function(key,value){if(key==='datasource')self.datasource(value,datasource)};self.setter=function(){if(skip)skip=false;else setTimeout2(self.ID,self.recalc,10)}});
// End: j-Selection

// Component: j-MinHeight
// Version: 1
// Updated: 2021-12-08 14:31
COMPONENT('minheight','parent:auto;margin:0;attr:min-height',function(self,config,cls){var timeout,init=false;self.readonly();self.make=function(){self.aclass(cls);self.on('resize2',self.resize);self.resizeforce()};self.resize=function(){timeout&&clearTimeout(timeout);timeout=setTimeout(self.resizeforce,200)};self.resizeforce=function(){if(config['disabled'+WIDTH()]){self.css(config.attr,config.minheight||'');return}var parent=self.parent(config.parent);var h=parent.height()-config.margin;if(config.topoffset)h-=self.element.offset().top;if(config.topposition)h-=self.element.position().top;if(config.minheight&&h<config.minheight)h=config.minheight;self.css(config.attr,h);if(!init){init=true;self.rclass('invisible hidden')}}});
// End: j-MinHeight

// Component: j-FloatingBox
// Version: 1
// Updated: 2021-10-06 21:23
COMPONENT('floatingbox','zindex:10',function(self,config,cls){var clsvisible='floatingbox-visible',is=false,open=[],makepath=function(val,scope){return val.replace(/\?/g,scope)};self.readonly();self.singleton();self.make=function(){var e_click=function(e){if(e.target===self.dom)self.hide()};var e_resize=function(){is&&self.hide(true)};self.bindedevents=false;self.bindevents=function(){if(!self.bindedevents){$(document).on('click',e_click);$(W).on('resize',e_resize);self.bindedevents=true}};self.unbindevents=function(){if(self.bindedevents){self.bindedevents=false;$(document).off('click',e_click);$(W).off('resize',e_resize)}};var fn=function(){is&&self.hide(true)};self.css('z-index',config.zindex);self.on('reflow + resize + resize2',fn);$(W).on('scroll',fn)};var animate=function(el){el.aclass(clsvisible)};self.show=function(opt){opt.box=$('.floatingbox[data-id="{0}"]'.format(opt.id));if(!opt.box.length){setTimeout(self.show,500,opt);return}opt.config=(opt.box.attrd('config')||'').parseConfig();if(opt.config.scope)opt.scope=opt.config.scope;else if(opt.config.path)opt.path=opt.config.path;opt.initialized=1;if(!opt.box[0].$processed){opt.initialized=0;opt.box[0].$processed=true;self.dom.appendChild(opt.box[0]);opt.box.rclass('invisible hidden')}var element=opt.element?$(opt.element):null;setTimeout(self.bindevents,500);var w=opt.box.width();var offset=element?element.offset():null;var width=w+(opt.offsetWidth||0);var options={left:opt.x||0,top:opt.y||0};if(opt.minwidth&&width<opt.minwidth){width=opt.minwidth;options.width=width}else if(opt.maxwidth&&width>opt.maxwidth){width=opt.maxwidth;options.width=width}if(element){switch(opt.align){case'center':options.left=Math.ceil((offset.left-width/2)+(opt.element.innerWidth()/2));break;case'right':options.left=(offset.left-width)+opt.element.innerWidth();break;default:options.left=offset.left;break}options.top=opt.position==='bottom'?((offset.top-opt.box.height())+element.height()):offset.top}if(opt.offsetX)options.left+=opt.offsetX;if(opt.offsetY)options.top+=opt.offsetY;var mw=width,mh=opt.box.height();if(options.left<0)options.left=10;else if((mw+options.left)>WW)options.left=(WW-mw)-10;if(options.top<0)options.top=10;else if((mh+options.top)>WH)options.top=(WH-mh)-10;options['z-index']=opt.config.zindex||(config.zindex+open.length+1);opt.box.css(options);opt.box.SETTER('*/resize');setTimeout(animate,50,opt.box);if(!open.findItem('id',opt.id))open.push(opt);if(!opt.scope)opt.scope=opt.box.attrd('scope');opt.prevscope=M.scope();opt.scope&&M.scope(opt.scope);self.aclass(cls+'-visible');opt.init&&opt.init();if(!opt.initialized&&opt.config.init)EXEC(makepath(opt.config.init,opt.scope),opt.box);opt.config.reload&&EXEC(makepath(opt.config.reload,opt.scope),opt.box);opt.mouseleave&&opt.box.on('mouseleave',function(e){opt.mouseleave(e,function(){close(opt)})});opt.autofocus&&self.autofocus(opt.autofocus);is=true};var close=function(item){if(item){item.box.rclass(clsvisible);item.hide&&item.hide(item.box);item.config.hide&&EXEC(makepath(item.config.hide,item.scope),item.box);item.mouseleave&&item.box.off('mouseleave',item.mouseleave);item.prevscope&&M.scope(item.prevscope)}};self.hide=function(all){if(all){if(typeof(all)==='string'){var index=open.findIndex('id',all);var count=open.length-index;for(var i=0;i<=count;i++)close(open.pop())}else{while(open.length)close(open.pop())}}else close(open.pop());if(!open.length){self.rclass(cls+'-visible');self.unbindevents()}}});
// End: j-FloatingBox

// Component: j-Menu
// Version: 1
// Updated: 2020-12-03 11:08
COMPONENT('menu',function(self,config,cls){self.singleton();self.readonly();self.nocompile&&self.nocompile();var cls2='.'+cls,is=false,issubmenu=false,isopen=false,events={},ul,children,prevsub,parentclass;self.make=function(){self.aclass(cls+' hidden '+cls+'-style-'+(config.style||1));self.append('<div class="{0}-items"><ul></ul></div><div class="{0}-submenu hidden"><ul></ul></div>'.format(cls));ul=self.find(cls2+'-items').find('ul');children=self.find(cls2+'-submenu');self.event('click','li',function(e){clearTimeout2(self.ID);var el=$(this);if(!el.hclass(cls+'-divider')&&!el.hclass(cls+'-disabled')){self.opt.scope&&M.scope(self.opt.scope);var index=el.attrd('index').split('-');if(index.length>1){self.opt.callback(self.opt.items[+index[0]].children[+index[1]]);self.hide()}else if(!issubmenu){self.opt.callback(self.opt.items[+index[0]]);self.hide()}}e.preventDefault();e.stopPropagation()});events.hide=function(){is&&self.hide()};self.event('scroll',events.hide);self.on('reflow + scroll + resize + resize2',events.hide);events.click=function(e){if(is&&!isopen&&(!self.target||(self.target!==e.target&&!self.target.contains(e.target))))setTimeout2(self.ID,self.hide,isMOBILE?700:300)};events.hidechildren=function(){if($(this.parentNode.parentNode).hclass(cls+'-items')){if(prevsub&&prevsub[0]!==this){prevsub.rclass(cls+'-selected');prevsub=null;children.aclass('hidden');issubmenu=false}}};events.children=function(){if(prevsub&&prevsub[0]!==this){prevsub.rclass(cls+'-selected');prevsub=null}issubmenu=true;isopen=true;setTimeout(function(){isopen=false},500);var el=prevsub=$(this);var index=+el.attrd('index');var item=self.opt.items[index];el.aclass(cls+'-selected');var html=self.makehtml(item.children,index);children.find('ul').html(html);children.rclass('hidden');var css={},offset=el.position();css.left=ul.width()-5;css.top=offset.top-5;var offsetX=offset.left;offset=self.element.offset();var w=children.width();var left=offset.left+css.left+w;if(left>WW+30)css.left=(offsetX-w)+5;children.css(css)}};self.bindevents=function(){events.is=true;$(document).on('touchstart mouseenter mousedown',cls2+'-children',events.children).on('touchstart mousedown',events.click);$(W).on('scroll',events.hide);self.element.on('mouseenter','li',events.hidechildren)};self.unbindevents=function(){events.is=false;$(document).off('touchstart mouseenter mousedown',cls2+'-children',events.children).off('touchstart mousedown',events.click);$(W).off('scroll',events.hide);self.element.off('mouseenter','li',events.hidechildren)};self.showxy=function(x,y,items,callback){var opt={};opt.x=x;opt.y=y;opt.items=items;opt.callback=callback;self.show(opt)};self.makehtml=function(items,index){var builder=[],tmp;for(var i=0;i<items.length;i++){var item=items[i];if(typeof(item)==='string'){if(item==='-')tmp='<hr />';else tmp='<span>{0}</span>'.format(item);builder.push('<li class="{0}-divider">{1}</li>'.format(cls,tmp));continue}var cn=item.classname||'',icon='';if(item.icon)icon='<i class="{0}"></i>'.format(item.icon.charAt(0)==='!'?item.icon.substring(1):item.icon.indexOf('fa-')===-1?('fa fa-'+item.icon):item.icon);else cn=(cn?(cn+' '):'')+cls+'-nofa';tmp='';if(index==null&&item.children&&item.children.length){cn+=(cn?' ':'')+cls+'-children';tmp+='<i class="fa fa-play pull-right"></i>'}if(item.selected)cn+=(cn?' ':'')+cls+'-selected';if(item.disabled)cn+=(cn?' ':'')+cls+'-disabled';tmp+='<div class="{0}-name">{1}{2}{3}</div>'.format(cls,icon,item.name,item.shortcut?'<b>{0}</b>'.format(item.shortcut):'');if(item.note)tmp+='<div class="ui-menu-note">{0}</div>'.format(item.note);builder.push('<li class="{0}" data-index="{2}">{1}</li>'.format(cn,tmp,(index!=null?(index+'-'):'')+i))}return builder.join('')};self.show=function(opt){if(typeof(opt)==='string'){opt={align:opt};opt.element=arguments[1];opt.items=arguments[2];opt.callback=arguments[3];opt.offsetX=arguments[4];opt.offsetY=arguments[5]}var tmp=opt.element?opt.element instanceof jQuery?opt.element[0]:opt.element.element?opt.element.dom:opt.element:null;if(is&&tmp&&self.target===tmp){self.hide();return}var tmp;self.target=tmp;self.opt=opt;opt.scope=M.scope();if(parentclass&&opt.classname!==parentclass){self.rclass(parentclass);parentclass=null}if(opt.large)self.aclass('ui-large');else self.rclass('ui-large');isopen=false;issubmenu=false;prevsub=null;var css={};children.aclass('hidden');children.find('ul').empty();clearTimeout2(self.ID);ul.html(self.makehtml(opt.items));if(!parentclass&&opt.classname){self.aclass(opt.classname);parentclass=opt.classname}if(is){css.left=0;css.top=0;self.element.css(css)}else{self.rclass('hidden');self.aclass(cls+'-visible',100);is=true;if(!events.is)self.bindevents()}var target=$(opt.element);var w=self.width();var offset=target.offset();if(opt.element){switch(opt.align){case'center':css.left=Math.ceil((offset.left-w/2)+(target.innerWidth()/2));break;case'right':css.left=(offset.left-w)+target.innerWidth();break;default:css.left=offset.left;break}css.top=opt.position==='bottom'?(offset.top-self.element.height()-10):(offset.top+target.innerHeight()+10)}else{css.left=opt.x;css.top=opt.y}if(opt.position==='bottom')css.top+=10;else css.top-=10;if(opt.offsetX)css.left+=opt.offsetX;if(opt.offsetY)css.top+=opt.offsetY;var mw=w,mh=self.height();if(css.left<0)css.left=10;else if((mw+css.left)>WW)css.left=(WW-mw)-10;if(css.top<0)css.top=10;else if((mh+css.top)>WH)css.top=(WH-mh)-10;self.element.css(css)};self.hide=function(){events.is&&self.unbindevents();is=false;self.opt&&self.opt.hide&&self.opt.hide();self.target=null;self.opt=null;self.aclass('hidden');self.rclass(cls+'-visible')}});
// End: j-Menu

// Component: j-MiniForm
// Version: 2
// Updated: 2021-11-10 12:30
COMPONENT('miniform','zindex:12',function(self,config,cls){var cls2='.'+cls,csspos={};if(!W.$$miniform){W.$$miniform_level=W.$$miniform_level||1;W.$$miniform=true;$(document).on('click',cls2+'-button-close',function(){SET($(this).attrd('path'),'')});var resize=function(){setTimeout2(self.name,function(){for(var i=0;i<M.components.length;i++){var com=M.components[i];if(com.name==='miniform'&&!HIDDEN(com.dom)&&com.$ready&&!com.$removed)com.resize()}},200)};ON('resize2',resize);$(document).on('click',cls2+'-container',function(e){if(e.target===this){var com=$(this).component();if(com&&com.config.closeoutside){com.set('');return}}var el=$(e.target);if(el.hclass(cls+'-container-cell')){var form=$(this).find(cls2);var c=cls+'-animate-click';form.aclass(c).rclass(c,300);var com=el.parent().component();if(com&&com.config.closeoutside)com.set('')}})}self.readonly();self.submit=function(){if(config.submit)self.EXEC(config.submit,self.hide,self.element);else self.hide()};self.cancel=function(){config.cancel&&self.EXEC(config.cancel,self.hide);self.hide()};self.hide=function(){if(config.independent)self.hideforce();self.esc(false);self.set('')};self.esc=function(bind){if(bind){if(!self.$esc){self.$esc=true;$(W).on('keydown',self.esc_keydown)}}else{if(self.$esc){self.$esc=false;$(W).off('keydown',self.esc_keydown)}}};self.esc_keydown=function(e){if(e.which===27&&!e.isPropagationStopped()){var val=self.get();if(!val||config.if===val){e.preventDefault();e.stopPropagation();self.hide()}}};self.hideforce=function(){if(!self.hclass('hidden')){self.aclass('hidden');self.release(true);self.find(cls2).rclass(cls+'-animate');W.$$miniform_level--}};self.icon=function(value){var el=this.rclass2('fa');value.icon&&el.aclass(value.icon.indexOf(' ')===-1?('fa fa-'+value.icon):value.icon);this.tclass('hidden',!value.icon)};self.resize=function(){if(!config.center||self.hclass('hidden'))return;var ui=self.find(cls2);var fh=ui.innerHeight();var wh=WH,r=(wh/2)-(fh/2);csspos.marginTop=(r>30?(r-15):20)+'px';ui.css(csspos)};self.make=function(){$(document.body).append('<div id="{0}" class="hidden {4}-container invisible"><div class="{4}-container-table"><div class="{4}-container-cell"><div class="{4}" style="max-width:{1}px"><div data-bind="@config__text span:value.title__change .{4}-icon:@icon" class="{4}-title"><button name="cancel" class="{4}-button-close{3}" data-path="{2}"><i class="fa fa-times"></i></button><i class="{4}-icon"></i><span></span></div></div></div></div>'.format(self.ID,config.width||800,self.path,config.closebutton==false?' hidden':'',cls));var scr=self.find('> script');self.template=scr.length?scr.html().trim():'';if(scr.length)scr.remove();var el=$('#'+self.ID);var body=el.find(cls2)[0];while(self.dom.children.length)body.appendChild(self.dom.children[0]);self.rclass('hidden invisible');self.replace(el,true);self.event('scroll',function(){EMIT('scroll',self.name);EMIT('reflow',self.name)});self.event('click','button[name]',function(){var t=this;switch(t.name){case'submit':self.submit(self.hide);break;case'cancel':!t.disabled&&self[t.name](self.hide);break}});config.enter&&self.event('keydown','input',function(e){e.which===13&&!self.find('button[name="submit"]')[0].disabled&&setTimeout2(self.ID+'enter',self.submit,500)})};self.configure=function(key,value,init,prev){if(!init){switch(key){case'width':value!==prev&&self.find(cls2).css('max-width',value+'px');break;case'closebutton':self.find(cls2+'-button-close').tclass('hidden',value!==true);break}}};self.setter=function(value){setTimeout2(cls+'-noscroll',function(){$('html').tclass(cls+'-noscroll',!!$(cls2+'-container').not('.hidden').length)},50);var isHidden=value!==config.if;if(self.hclass('hidden')===isHidden){if(!isHidden){config.reload&&self.EXEC(config.reload,self);config.default&&DEFAULT(self.makepath(config.default),true)}return}setTimeout2(cls,function(){EMIT('reflow',self.name)},10);if(isHidden){if(!config.independent)self.hideforce();return}if(self.template){var is=self.template.COMPILABLE();self.find(cls2).append(self.template);self.template=null;is&&COMPILE()}if(W.$$miniform_level<1)W.$$miniform_level=1;W.$$miniform_level++;self.css('z-index',W.$$miniform_level*config.zindex);self.rclass('hidden');self.resize();self.release(false);config.reload&&self.EXEC(config.reload,self);config.default&&DEFAULT(self.makepath(config.default),true);setTimeout(function(){self.rclass('invisible');self.find(cls2).aclass(cls+'-animate');config.autofocus&&self.autofocus(config.autofocus)},200);setTimeout2(self.ID,function(){self.css('z-index',(W.$$miniform_level*config.zindex)+1)},400);config.closeesc&&self.esc(true)}});
// End: j-MiniForm

// Component: j-DataGrid
// Version: 2
// Updated: 2022-01-04 14:02
COMPONENT('datagrid','checkbox:true;colwidth:150;rowheight:28;minheight:200;clusterize:true;limit:80;filterlabel:Filter;height:auto;margin:0;resize:true;reorder:true;sorting:true;boolean:true,on,yes;pluralizepages:# pages,# page,# pages,# pages;pluralizeitems:# items,# item,# items,# items;remember:true;highlight:false;unhighlight:true;autoselect:false;buttonapply:Apply;buttonreset:Reset;allowtitles:false;fullwidth_xs:false;clickid:id;dirplaceholder:Search;autoformat:1;controls:1;hfuncicon:square-root-alt',function(self,config){var opt={filter:{},filtercache:{},filtercl:{},filtervalues:{},scroll:false,selected:{},operation:''},header,vbody,footer,container,ecolumns,isecolumns=false,ready=false,sheader,sbody,econtrols,Theadercol=Tangular.compile('<div class="dg-hcol dg-col-{{ index}}{{ if sorting}} dg-sorting{{ fi}}" data-index="{{ index}}">{{ if sorting}}<i class="dg-sort fa fa-sort"></i>{{ fi}}<div class="dg-label{{ alignheader}}"{{ if labeltitle}} title="{{ labeltitle}}"{{ fi}}{{ if reorder}} draggable="true"{{ fi}}>{{ label | raw}}</div>{{ if filter}}<div class="dg-filter{{ alignfilter}}{{ if filterval != null && filterval !== \'\' }} dg-filter-selected{{ fi}}"><i class="fa dg-filter-cancel fa-times"></i>{{ if options}}<label data-name="{{ name}}">{{ if filterval}}{{ filterval}}{{ else}}{{ filter}}{{ fi}}</label>{{ else}}<input autocomplete="new-password" type="text" placeholder="{{ filter}}" class="dg-filter-input" name="{{ name}}{{ ts}}" data-name="{{ name}}" value="{{ filterval}}" />{{ fi}}</div>{{ else}}<div class="dg-filter-empty">&nbsp;</div>{{ fi}}</div>');var isIE=(/msie|trident/i).test(navigator.userAgent);var isredraw=false,forcescroll='',schemas={},controls={el:null,timeout:null,is:false,cache:{}};self.meta=opt;function Cluster(el){var self=this,dom=el[0],scrollel=el;self.row=config.rowheight;self.rows=[];self.limit=config.limit;self.pos=-1;self.enabled=!!config.clusterize;self.plus=0;self.scrolltop=0;self.prev=0;var seh='<div style="height:0"></div>',set=$(seh);var seb=$(seh);var div=document.createElement('DIV');dom.appendChild(set[0]);dom.appendChild(div);dom.appendChild(seb[0]);self.el=$(div);self.render=function(){var t=self.pos*self.frame,b=(self.rows.length*self.row)-(self.frame*2)-t;var pos=self.pos*self.limit,posto=pos+(self.limit*2);set.css('height',t);seb.css('height',b<2?isMOBILE?(config.exec?(self.row+1):(self.row*2.25))>>0:3:b);var tmp=self.scrollbar[0].scrollTop,node=self.el[0];var child=node.firstChild;while(child){node.removeChild(child);child=node.firstChild}for(var i=pos;i<posto;i++){if(typeof(self.rows[i])==='string')self.rows[i]=$(self.rows[i])[0];if(self.rows[i])node.appendChild(self.rows[i]);else break}if(self.prev<t)self.scrollbar[0].scrollTop=t;else self.scrollbar[0].scrollTop=tmp;self.prev=t;if(self.grid.selected){var index=opt.rows.indexOf(self.grid.selected);if(index!==-1&&(index>=pos||index<=(pos+self.limit)))self.el.find('.dg-row[data-index="{0}"]'.format(index)).aclass('dg-selected')}};self.scrolling=function(){var y=self.scrollbar[0].scrollTop+1;self.scrolltop=y;if(y<0)return;var frame=Math.ceil(y/self.frame)-1;if(frame===-1)return;if(self.pos!==frame){var plus=(self.el[0].offsetHeight/2)-self.frame;if(plus>0){frame=Math.ceil(y/(self.frame+plus))-1;if(self.pos===frame)return}if(self.max&&frame>=self.max)frame=self.max;self.pos=frame;if(self.enabled)self.render();else{var node=self.el[0],child=node.firstChild;while(child){node.removeChild(child);child=node.firstChild}for(var i=0;i<self.rows.length;i++){if(typeof(self.rows[i])==='string')self.rows[i]=$(self.rows[i])[0];self.el[0].appendChild(self.rows[i])}}self.scroll&&self.scroll();config.change&&self.grid.SEEX(config.change,null,null,self.grid)}};self.update=function(rows,noscroll){if(noscroll!=true)self.el[0].scrollTop=0;self.limit=config.limit;self.pos=-1;self.rows=rows;self.max=Math.ceil(rows.length/self.limit)-1;self.frame=self.limit*self.row;if(!self.enabled){self.frame=1000000}else if(config.height==='fluid'){self.limit=1000000}else if(self.limit*2>rows.length){self.limit=rows.length;self.frame=self.limit*self.row;self.max=1}self.scrolling()};self.destroy=function(){self.el.off('scroll');self.rows=null};self.scrollbar=scrollel.closest('.ui-scrollbar-area');self.scrollbar.on('scroll',self.scrolling)}self.destroy=function(){opt.cluster&&opt.cluster.destroy()};self.init=function(){ON('resize + resize2',function(){setTimeout2('datagridresize',ASETTER('datagrid/resize'),500)});Thelpers.ui_datagrid_autoformat=function(val,type){switch(type){case'email':return val&&val.length>2?'<a href="mailto:{0}" class="dg-link"><i class="far fa-envelope"></i>{0}</a>'.format(val):val;case'phone':return val&&val.length>2?'<a href="tel:{0}" class="dg-link"><i class="fas fa-phone"></i>{0}</a>'.format(val):val;case'url':return val&&val.length>7&&(/http(s):\/\//i).test(val)?'<a href="{0}" target="_blank" class="dg-link"><i class="fas fa-globe"></i>{0}</a>'.format(val):val}return val};Thelpers.ui_datagrid_checkbox=function(val){return'<div class="dg-checkbox'+(val?' dg-checked':'')+'" data-custom="1"><i class="fa fa-check"></i></div>'};Thelpers.ui_datagrid_colorize=function(val,encode){var hash=HASH(val+'');var color='#';for(var i=0;i<3;i++){var value=(hash>>(i*8))&0xFF;color+=('00'+value.toString(16)).substr(-2)}return'<span style="background:{0}" class="dg-colorize">{1}</span>'.format(color,encode?Thelpers.encode(val):val)}};self.readonly();self.bindvisible();self.nocompile();var reconfig=function(){self.tclass('dg-clickable',!!(config.click||config.dblclick))};self.configure=function(key,value,init){switch(key){case'noborder':self.tclass('dg-noborder',!!value);break;case'checkbox':case'numbering':!init&&self.cols(NOOP);break;case'pluralizepages':config.pluralizepages=value.split(',').trim();break;case'pluralizeitems':config.pluralizeitems=value.split(',').trim();break;case'checked':case'button':case'exec':if(value&&value.SCOPE)config[key]=value.SCOPE(self,value);break;case'dblclick':if(value&&value.SCOPE)config.dblclick=value.SCOPE(self,value);break;case'click':if(value&&value.SCOPE)config.click=value.SCOPE(self,value);break;case'columns':self.datasource(value,function(path,value,type){if(value){opt.sort=null;opt.filter={};opt.scroll='';opt.selected={};self.rebind(value,true);type&&self.setter(null)}});break;case'hfunc':if(value&&typeof(value)==='string')config.hfunc=self.makepath(value);break}setTimeout2(self.ID+'reconfigure',reconfig)};self.refresh=function(){self.refreshfilter()};self.applycolumns=function(use){isecolumns=false;ecolumns.aclass('hidden');if(use){var nothidden={};ecolumns.find('.dg-columns-checkbox-checked').each(function(){nothidden[this.getAttribute('data-id')]=true});self.cols(function(cols){for(var i=0;i<cols.length;i++){var col=cols[i];col.hidden=nothidden[col.id]!==true}})}};self.fn_in_changed=function(arr){config.changed&&self.SEEX(config.changed,arr||self.changed(),self)};self.fn_in_checked=function(arr){config.checked&&self.SEEX(config.checked,arr||self.checked(),self)};self.fn_refresh=function(){setTimeout2(self.ID+'filter',function(){if(config.exec)self.operation(opt.operation);else self.refreshfilter(true)},50)};self.make=function(){self.IDCSS=GUID(5);self.aclass('dg dg-noscroll dg-'+self.IDCSS+(config.height==='fluid'?' dg-fluid':''));self.find('script').each(function(){var el=$(this);var id=el.attrd('id');if(id)schemas[id]=el.html();if(!schemas.default)schemas.default=el.html()});controls.show=function(dom){if(controls.ishidding||!opt.controls||!config.controls)return;var el=$(dom);var off=el.position();var css={},clshover='dg-row-hover',index=el.attrd('index');controls.el&&controls.el.rclass(clshover);controls.el=$(dom).aclass(clshover);var div=controls.cache[index];if(div===null){controls.hide();return}if(!div){var html=opt.controls(opt.rows[+index]);div=controls.cache[index]=html?$('<div>'+html+'</div>')[0]:null;controls.cache[index]=div;if(div===null){controls.hide();return}}while(true){var child=econtrols[0].firstChild;if(child)econtrols[0].removeChild(child);else break}econtrols[0].appendChild(div);css.top=Math.ceil(off.top-((econtrols.height()/2)-(config.rowheight/2)))-2;econtrols.css(css).rclass('hidden').aclass('dg-controls-visible',50).attrd('index',index);controls.timeout=null;controls.is=true;controls.y=self.scrollbarY?self.scrollbarY.scrollTop():0};controls.hide=function(type){if(controls.is){if(type===1){var y=self.scrollbarY?self.scrollbarY.scrollTop():0;if(controls.y===y)return}else if(type===2){controls.ishidding=true;setTimeout(function(){controls.ishidding=false},1000)}controls.el.rclass('dg-row-hover');controls.el=null;controls.is=false;econtrols.aclass('hidden').rclass('dg-controls-visible')}};ON('scroll',function(){controls.hide(1)});self.event('mouseenter','.dg-row',function(e){controls.timeout&&clearTimeout(controls.timeout);controls.timeout=setTimeout(controls.show,controls.is?50:500,this,e)});var pagination='';if(config.exec)pagination='<div class="dg-footer hidden"><div class="dg-pagination-items hidden-xs"></div><div class="dg-pagination"><button name="page-first" disabled><i class="fa fa-angle-double-left"></i></button><button name="page-prev" disabled><i class="fa fa-angle-left"></i></button><div><input type="text" name="page" maxlength="5" class="dg-pagination-input" /></div><button name="page-next" disabled><i class="fa fa-angle-right"></i></button><button name="page-last" disabled><i class="fa fa-angle-double-right"></i></button></div><div class="dg-pagination-pages"></div></div>';self.dom.innerHTML='<div class="dg-btn-columns"><i class="fa fa-caret-left"></i><span class="fa fa-columns"></span></div><div class="dg-columns hidden"><div><div class="dg-columns-body"></div></div><button class="dg-columns-button" name="columns-apply"><i class="fa fa-check-circle"></i>{1}</button><span class="dt-columns-reset">{2}</span></div><div class="dg-container"><div class="dg-controls"></div><span class="dg-resize-line hidden"></span><div class="dg-header-scrollbar"><div class="dg-header"></div><div class="dg-body-scrollbar"><div class="dg-body"></div></div></div></div>{0}'.format(pagination,config.buttonapply,config.buttonreset);header=self.find('.dg-header');vbody=self.find('.dg-body');footer=self.find('.dg-footer');container=self.find('.dg-container');ecolumns=self.find('.dg-columns');sheader=self.find('.dg-header-scrollbar');sbody=self.find('.dg-body-scrollbar');econtrols=self.find('.dg-controls');container.on('mouseleave',function(){controls.hide(2)});self.scrollbarY=config.height!=='fluid'?SCROLLBAR(sbody,{visibleY:true,orientation:'y',controls:container,marginY:isMOBILE?0:54}):null;self.scrollbarX=SCROLLBAR(sheader,{visibleX:true,orientation:'x',controls:container});if(schemas.default){self.rebind(schemas.default);schemas.$current='default'}var events={};events.mouseup=function(e){if(r.is){r.is=false;r.line.aclass('hidden');r.el.css('height',r.h);var x=r.el.css('left').parseInt();var index=+r.el.attrd('index');var width=opt.cols[index].width+(x-r.x);self.resizecolumn(index,width);e.preventDefault();e.stopPropagation()}events.unbind()};container.on('contextmenu',function(e){if(config.contextmenu){e.preventDefault();self.EXEC(config.contextmenu,e,self)}});events.unbind=function(){$(W).off('mouseup',events.mouseup).off('mousemove',events.mousemove)};events.bind=function(){$(W).on('mouseup',events.mouseup).on('mousemove',events.mousemove)};var hidedir=function(){ishidedir=true;SETTER('!directory','hide');setTimeout(function(){ishidedir=false},800)};var ishidedir=false,r={is:false};self.event('click','.dg-btn-columns',function(e){e.preventDefault();e.stopPropagation();controls.hide();var cls='hidden';if(isecolumns){self.applycolumns()}else{var builder=[];for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];(col.listcolumn&&!col.$hidden)&&builder.push('<div><label class="dg-columns-checkbox{1}" data-id="{0}"><span><i class="fa fa-check"></i></span>{2}</label></div>'.format(col.id,col.hidden?'':' dg-columns-checkbox-checked',col.text))}ecolumns.find('.dg-columns-body')[0].innerHTML=builder.join('');ecolumns.rclass(cls);isecolumns=true}});header.on('click','label',function(){var el=$(this);var index=+el.closest('.dg-hcol').attrd('index');var col=opt.cols[index],opts=col.options instanceof Array?col.options:GET(self.makepath(col.options));var dir={};if(typeof opts==='function')opts=opts();controls.hide();dir.element=el;dir.items=opts;dir.key=col.otext;dir.offsetX=-6;dir.offsetY=-2;dir.placeholder=config.dirplaceholder;dir.callback=function(item){self.applyfilterdirectory(el,col,item)};SETTER('directory','show',dir)});self.event('dblclick','.dg-col',function(e){controls.hide();e.preventDefault();e.stopPropagation();self.editcolumn($(this))});var dblclick={ticks:0,id:null,row:null};r.line=container.find('.dg-resize-line');var findclass=function(node){var count=0;while(true){for(var i=1;i<arguments.length;i++){if(node.classList.contains(arguments[i]))return true}node=node.parentNode;if((count++)>4)break}};self.event('click','.dg-row',function(e){var now=Date.now();var el=$(this);var type=e.target.tagName,target=$(e.target);if((type==='DIV'||type==='SPAN')){var cls='dg-selected',elrow=el.closest('.dg-row');var index=+elrow.attrd('index');var row=opt.rows[index];if(!row)return;if(config.dblclick&&dblclick.ticks&&dblclick.ticks>now&&dblclick.row===row&&!findclass(e.target,'dg-checkbox','dg-editable')){config.dblclick&&self.SEEX(config.dblclick,row,self,elrow,target);if(config.highlight&&self.selected!==row){opt.cluster.el.find('.'+cls).rclass(cls);self.selected=row;elrow.aclass(cls)}e.preventDefault();return}dblclick.row=row;dblclick.ticks=now+300;var rowarg=row;if(config.highlight){opt.cluster.el.find('.'+cls).rclass(cls);if(!config.unhighlight||self.selected!==row){self.selected=row;elrow.aclass(cls);controls.show(el[0])}else{rowarg=self.selected=null;controls.is&&controls.hide()}}else{if(controls.is)controls.hide();else if(rowarg)controls.show(el[0])}config.click&&self.SEEX(config.click,rowarg,self,elrow,target)}});self.reload=function(){self.operation('refresh')};self.empty=function(){self.set({page:1,pages:0,count:0,items:[],limit:0})};self.released=function(is){!is&&setTimeout(self.resize,500)};self.event('click','.dg-filter-cancel,.dt-columns-reset',function(){var el=$(this);controls.hide();if(el.hclass('dt-columns-reset'))self.resetcolumns();else{var tmp=el.parent();var input=tmp.find('input');if(input.length){input.val('');input.trigger('change');return}var label=tmp.find('label');if(label.length){tmp.rclass('dg-filter-selected');var index=+el.closest('.dg-hcol').attrd('index');var col=opt.cols[index],k=label.attrd('name');label.html(col.filter);forcescroll=opt.scroll='y';opt.operation='filter';delete opt.filter[k];delete opt.filtervalues[col.id];delete opt.filtercl[k];self.fn_refresh()}}});self.event('click','.dg-label,.dg-sort',function(){var el=$(this).closest('.dg-hcol');controls.hide();if(!el.find('.dg-sort').length)return;var index=+el.attrd('index');for(var i=0;i<opt.cols.length;i++){if(i!==index)opt.cols[i].sort=0}var col=opt.cols[index];switch(col.sort){case 0:col.sort=1;break;case 1:col.sort=2;break;case 2:col.sort=0;break}opt.sort=col;opt.operation='sort';forcescroll='-';if(config.exec)self.operation(opt.operation);else self.refreshfilter(true)});isIE&&self.event('keydown','input',function(e){if(e.keyCode===13)$(this).blur();else if(e.keyCode===27)$(this).val('')});self.event('mousedown',function(e){var el=$(e.target);if(!el.hclass('dg-resize'))return;controls.hide();events.bind();var offset=self.element.offset().left;r.el=el;r.offset=offset;var prev=el.prev();r.min=(prev.length?prev.css('left').parseInt():(config.checkbox?70:30))+50;r.h=el.css('height');r.x=el.css('left').parseInt();r.line.css('height',opt.height);r.is=true;r.isline=false;e.preventDefault();e.stopPropagation()});header.on('mousemove',function(e){if(r.is){var x=(e.pageX-r.offset-10);var x2=self.scrollbarX.scrollLeft()+x;if(x2<r.min)x2=r.min;r.el.css('left',x2);r.line.css('left',x+9);if(!r.isline){r.isline=true;r.line.rclass('hidden')}e.preventDefault();e.stopPropagation()}});self.applyfilterdirectory=function(label,col,item){var val=item[col.ovalue],is=val!=null&&val!=='',name=label.attrd('name');opt.filtervalues[col.id]=val;if(is){if(opt.filter[name]==val)return;opt.filter[name]=val}else delete opt.filter[name];delete opt.filtercache[name];opt.filtercl[name]=val;forcescroll=opt.scroll='y';opt.operation='filter';label.parent().tclass('dg-filter-selected',is);label.text(is?(item[col.otext]||''):col.filter);self.fn_refresh()};var d={is:false};self.event('dragstart',function(e){!isIE&&e.originalEvent.dataTransfer.setData('text/plain',GUID())});self.event('dragenter dragover dragexit drop dragleave',function(e){e.stopPropagation();e.preventDefault();switch(e.type){case'drop':if(d.is){var col=opt.cols[+$(e.target).closest('.dg-hcol').attrd('index')];col&&self.reordercolumn(d.index,col.index)}d.is=false;break;case'dragenter':if(!d.is){d.index=+$(e.target).closest('.dg-hcol').attrd('index');d.is=true}return;case'dragover':return;default:return}});self.event('change','.dg-pagination-input',function(){var value=self.get();var val=+this.value;if(isNaN(val))return;if(val>=value.pages)val=value.pages;else if(val<1)val=1;value.page=val;forcescroll=opt.scroll='y';self.operation('page');controls.hide()});self.event('change','.dg-filter-input',function(){var input=this,$el=$(this);var el=$el.parent();var val=$el.val();var name=input.getAttribute('data-name');var col=opt.cols[+el.closest('.dg-hcol').attrd('index')];delete opt.filtercache[name];delete opt.filtercl[name];if(col.options){if(val)val=(col.options instanceof Array?col.options:GET(self.makepath(col.options)))[+val][col.ovalue];else val=null}var is=val!=null&&val!=='';if(col)opt.filtervalues[col.id]=val;if(is){if(opt.filter[name]==val)return;opt.filter[name]=val}else delete opt.filter[name];forcescroll=opt.scroll='y';opt.operation='filter';el.tclass('dg-filter-selected',is);self.fn_refresh();controls.hide()});self.select=function(row){var index;if(typeof(row)==='number'){index=row;row=opt.rows[index]}else if(row)index=opt.rows.indexOf(row);var cls='dg-selected';if(!row||index===-1){self.selected=null;opt.cluster&&opt.cluster.el.find('.'+cls).rclass(cls);config.highlight&&config.click&&self.SEEX(config.click,null,self);return}self.selected=row;var elrow=opt.cluster.el.find('.dg-row[data-index="{0}"]'.format(index));if(elrow&&config.highlight){opt.cluster.el.find('.'+cls).rclass(cls);elrow.aclass(cls)}config.click&&self.SEEX(config.click,row,self,elrow,null);controls.hide()};self.event('click','.dg-hfunc',function(e){var t=$(this);e.preventDefault();e.stopPropagation();self.SEEX(config.hfunc,t)});self.event('click','.dg-checkbox',function(e){var t=$(this);var custom=t.attrd('custom');if(custom==='1')return;e.preventDefault();e.stopPropagation();t.tclass('dg-checked');if(custom==='2')return;var val=t.attrd('value');var checked=t.hclass('dg-checked');if(val==='-1'){if(checked){opt.checked={};for(var i=0;i<opt.rows.length;i++)opt.checked[opt.rows[i].ROW]=1}else opt.checked={};self.scrolling()}else if(checked)opt.checked[val]=1;else delete opt.checked[val];self.fn_in_checked()});self.event('click','.dg-columns-checkbox',function(){$(this).tclass('dg-columns-checkbox-checked')});self.event('click','button',function(e){switch(this.name){case'columns-apply':self.applycolumns(true);break;case'page-first':forcescroll=opt.scroll='y';self.get().page=1;self.operation('page');break;case'page-last':forcescroll=opt.scroll='y';var tmp=self.get();tmp.page=tmp.pages;self.operation('page');break;case'page-prev':forcescroll=opt.scroll='y';self.get().page-=1;self.operation('page');break;case'page-next':forcescroll=opt.scroll='y';self.get().page+=1;self.operation('page');break;default:var el=$(this);var index=+el.closest('.dg-row,.dg-controls').attrd('index');var row=opt.rows[index];config.button&&self.SEEX(config.button,this.name,row,el,e);break}});self.scrollbarX.area.on('scroll',function(){!ishidedir&&hidedir();isecolumns&&self.applycolumns()});};self.operation=function(type){var value=self.get();if(value==null)value={};if(type==='filter'||type==='init')value.page=1;var keys=Object.keys(opt.filter);self.SEEX(config.exec,type,keys.length?opt.filter:null,opt.sort&&opt.sort.sort?[(opt.sort.name+'_'+(opt.sort.sort===1?'asc':'desc'))]:null,value.page,self);switch(type){case'sort':self.redrawsorting();break}};function align(type){return type===1?'center':type===2?'right':type}self.clear=function(){for(var i=0;i<opt.rows.length;i++)opt.rows[i].CHANGES=undefined;self.renderrows(opt.rows,true);opt.cluster&&opt.cluster.update(opt.render);self.fn_in_changed()};self.editcolumn=function(rindex,cindex){var col,row;if(cindex==null){if(rindex instanceof jQuery){cindex=rindex.attr('class').match(/\d+/);if(cindex)cindex=+cindex[0];else return;col=rindex}}else row=opt.cluster.el.find('.dg-row-'+(rindex+1));if(!col)col=row.find('.dg-col-'+cindex);var index=cindex;if(index==null)return;if(!row)row=col.closest('.dg-row');var data={};data.col=opt.cols[index];if(!data.col.editable)return;data.rowindex=+row.attrd('index');data.row=opt.rows[data.rowindex];data.colindex=index;data.value=data.row[data.col.name];data.elrow=row;data.elcol=col;var clone=col.clone();var cb=function(data){if(data==null){col.replaceWith(clone);return}data.row[data.col.name]=data.value;if(opt.rows[data.rowindex]!=data.row)opt.rows[data.rowindex]=data.row;if(!data.row.CHANGES)data.row.CHANGES={};data.row.CHANGES[data.col.name]=true;opt.render[data.rowindex]=$(self.renderrow(data.rowindex,data.row))[0];data.elrow.replaceWith(opt.render[data.rowindex]);self.fn_in_changed()};if(config.change)self.EXEC(config.change,data,cb,self);else self.datagrid_edit(data,cb)};self.applyfilter=function(obj,add){if(!ready){setTimeout(self.applyfilter,100,obj,add);return}if(!add)opt.filter={};for(var key in obj){var col=opt.cols.findItem('name',key);if(col.options){var items=col.options instanceof Array?col.options:GET(self.makepath(col.options));if(items instanceof Array){var item=items.findItem(col.ovalue,obj[key]);if(item){var el=header.find('.dg-hcol[data-index="{0}"] label'.format(col.index));if(el.length)self.applyfilterdirectory(el,col,item)}}}}header.find('input').each(function(){var t=this,el=$(t);var val=obj[el.attrd('name')];if(val!==undefined)el.val(val==null?'':val)}).trigger('change')};self.rebind=function(code,prerender){if(code.length<30&&code.indexOf(' ')===-1){schemas.$current=code;schemas[code]&&self.rebind(schemas[code]);return}opt.declaration=code;var type=typeof(code);if(type==='string'){code=code.trim();self.gridid='dg'+HASH(code)}else self.gridid='dg'+HASH(JSON.stringify(code));var cache=config.remember?W.PREF?W.PREF.get(self.gridid):CACHE(self.gridid):null;var cols=type==='string'?new Function('return '+code)():CLONE(code);var tmp;opt.rowclasstemplate=null;opt.search=false;opt.colsfilter={};for(var i=0;i<cols.length;i++){var col=cols[i];if(typeof(col)==='string'){opt.rowclasstemplate=Tangular.compile(col);cols.splice(i,1);i--;continue}if(col.type==='controls'||col.type==='buttons'){opt.controls=col.template?Tangular.compile(col.template):null;cols.splice(i,1);i--;continue}col.id=GUID(5);col.realindex=i;if(!col.name)col.name=col.id;if(col.listcolumn==null)col.listcolumn=true;if(col.hidden){col.$hidden=FN(col.hidden)(col)===true;col.hidden=col.$hidden}if(col.hide){col.hidden=col.hide===true;delete col.hide}if(col.options){!col.otext&&(col.otext='text');!col.ovalue&&(col.ovalue='value')}if(col.sort!=null)col.sorting=col.sort;if(cache){var c=cache[i];if(c){col.index=c.index;col.width=c.width;col.hidden=c.hidden}}if(col.index==null)col.index=i;if(col.sorting==null)col.sorting=config.sorting;if(col.alignfilter!=null)col.alignfilter=' '+align(col.alignfilter);if(col.alignheader!=null)col.alignheader=' '+align(col.alignheader);col.sort=0;if(col.search){opt.search=true;col.search=col.search===true?Tangular.compile(col.template):Tangular.compile(col.search)}if(!col.align){switch(col.type){case'date':col.align=1;break;case'number':col.align=2;break;case'boolean':col.align=1;break}}if(col.align&&col.align!=='left'){col.align=align(col.align);col.align=' '+col.align;if(!col.alignfilter)col.alignfilter=' center';if(!col.alignheader)col.alignheader=' center'}var cls=col.class?(' '+col.class):'';if(col.editable){cls+=' dg-editable';if(col.required)cls+=' dg-required'}if(config.autoformat){switch(col.type){case'number':if(col.monospace==null)col.monospace=true;break}}var isbool=col.type&&col.type.substring(0,4)==='bool';var TC=Tangular.compile;if(col.template){col.templatecustom=true;col.template=TC((col.template.indexOf('<button')===-1?('<div class="dg-value'+(col.monospace?' dg-monospace':'')+cls+'">{0}</div>'):'{0}').format(col.template))}else col.template=TC(('<div class="'+(isbool?'dg-bool':('dg-value'+(col.monospace?' dg-monospace':'')))+cls+'"'+(config.allowtitles?' title="{{ {0} }}"':'')+'>{{ {0} }}</div>').format(col.name+(col.currency?' | currency(\'{0}\')'.format(col.currency):col.format!=null?' | format({0})'.format(col.format&&typeof(col.format)==='string'?('\''+col.format+'\''):col.format):'')+(col.type&&config.autoformat?' | ui_datagrid_autoformat(\'{0}\')'.format(col.type):'')+(col.empty?' | def({0})'.format(col.empty===true||col.empty=='1'?'':('\''+col.empty+'\'')):'')+(isbool?' | ui_datagrid_checkbox':'')+(col.colorize?(' | ui_datagrid_colorize('+(col.currency||col.format?0:1)+')'):'')));if(col.header)col.header=TC(col.header);else col.header=TC('{{ text | raw}}');if(!col.text)col.text=col.name;if(col.text.substring(0,1)==='.')col.text='<i class="{0}"></i>'.format(col.text.substring(1));if(col.filter!==false&&!col.filter)col.filter=config.filterlabel;if(col.filtervalue!=null){tmp=col.filtervalue;if(typeof(tmp)==='function')tmp=tmp(col);opt.filter[col.name]=opt.filtervalues[col.id]=tmp}opt.colsfilter[col.name]=col}cols.quicksort('index');opt.cols=cols;self.rebindcss();prerender&&self.rendercols();controls.hide();};self.rebindcss=function(){var cols=opt.cols,css=[],indexes={};opt.width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+30;for(var i=0;i<cols.length;i++){var col=cols[i];if(!col.width)col.width=config.colwidth;css.push('.dg-{2} .dg-col-{0}{width:{1}px}'.format(i,col.width,self.IDCSS));if(!col.hidden){opt.width+=col.width;indexes[i]=opt.width}}CSS(css,self.ID);var w=self.width();if(w>opt.width)opt.width=w-2;if(sheader){css={width:opt.width};header.css(css);}header&&header.find('.dg-resize').each(function(){var el=$(this);el.css('left',indexes[el.attrd('index')]-39)})};self.cols=function(callback){callback(opt.cols);opt.cols.quicksort('index');self.rebindcss();self.rendercols();opt.rows&&self.renderrows(opt.rows);self.save();opt.cluster&&opt.cluster.update(opt.render);self.resize()};self.rendercols=function(){var Trow='<div class="dg-hrow dg-row-{0}">{1}</div>';if(config.hfunc)config.numbering='<div class="dg-hfunc dg-hfunc-main" data-value="-1"><i class="{0}"></i></div>'.format(self.faicon(config.hfuncicon));var column=config.numbering!==false?Theadercol({index:-1,label:config.numbering,filter:false,name:'$',sorting:false}):'';var resize=[];opt.width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+30;if(config.checkbox)column+=Theadercol({index:-1,label:'<div class="dg-checkbox dg-checkbox-main" data-value="-1"><i class="fa fa-check"></i></div>',filter:false,name:'$',sorting:false});for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];if(!col.hidden){var filteritems=col.options?col.options instanceof Array?col.options:GET(self.makepath(col.options)):null;var filtervalue=opt.filtervalues[col.id],obj={index:i,ts:NOW.getTime(),label:col.header(col),filter:col.filter,reorder:config.reorder,sorting:col.sorting,name:col.name,alignfilter:col.alignfilter,alignheader:col.alignheader,filterval:filtervalue==null?null:filteritems?filteritems.findValue(col.ovalue,filtervalue,col.otext,'???'):filtervalue,labeltitle:col.title||col.text,options:filteritems};opt.width+=col.width;config.resize&&resize.push('<span class="dg-resize" style="left:{0}px" data-index="{1}"></span>'.format(opt.width-39,i));column+=Theadercol(obj)}}column+='<div class="dg-hcol"></div>';header[0].innerHTML=resize.join('')+Trow.format(0,column);var w=self.width();if(w>opt.width)opt.width=w;self.redrawsorting()};self.redraw=function(update){var x=self.scrollbarX.scrollLeft();var y=self.scrollbarY?self.scrollbarY.scrollTop():0;isredraw=update?2:1;self.refreshfilter();isredraw=0;self.scrollbarX.scrollLeft(x);self.scrollbarY&&self.scrollbarY.scrollTop(y)};self.redrawrow=function(oldrow,newrow){var index=opt.rows.indexOf(oldrow);if(index!==-1){controls.cache={};if(newrow){if(self.selected===oldrow)self.selected=newrow;oldrow=opt.rows[index]=newrow}var el=vbody.find('.dg-row[data-index="{0}"]'.format(index));if(el.length){opt.render[index]=$(self.renderrow(index,oldrow))[0];el[0].parentNode.replaceChild(opt.render[index],el[0])}}};self.appendrow=function(row,scroll,prepend){var index=prepend?0:(opt.rows.push(row)-1);var model=self.get();controls.cache={};if(model==null){return}else{var arr=model.items?model.items:model;if(prepend){arr.unshift(row)}else if(model.items)arr.push(row);else arr.push(row)}if(prepend){var tmp;for(var i=0;i<opt.render.length;i++){var node=opt.render[i];if(typeof(node)==='string')node=opt.render[i]=$(node)[0];var el=$(node);var tmpindex=i+1;tmp=el.rclass2('dg-row-').aclass('dg-row-'+tmpindex).attrd('index',tmpindex);tmp.find('.dg-number').html(tmpindex+1);tmp.find('.dg-checkbox-main').attrd('value',tmpindex);if(opt.rows[i])opt.rows[i].ROW=tmpindex}row.ROW=index;tmp={};var keys=Object.keys(opt.checked);for(var i=0;i<keys.length;i++)tmp[(+keys[i])+1]=1;opt.checked=tmp;opt.render.unshift(null)}opt.render[index]=$(self.renderrow(index,row))[0];opt.cluster&&opt.cluster.update(opt.render,!opt.scroll||opt.scroll==='-');if(scroll){var el=opt.cluster.el[0];el.scrollTop=el.scrollHeight}self.scrolling()};self.renderrow=function(index,row,plus){if(plus===undefined&&config.exec){var val=self.get();plus=(val.page-1)*val.limit}var Trow='<div><div class="dg-row dg-row-{0}{3}{4}" data-index="{2}">{1}</div></div>',Tcol='<div class="dg-col dg-col-{0}{2}{3}">{1}</div>',column='';if(config.numbering!==false)column+=Tcol.format(-1,'<div class="dg-number">{0}</div>'.format(index+1+(plus||0)));if(config.checkbox)column+=Tcol.format(-1,'<div class="dg-checkbox-main dg-checkbox{1}" data-value="{0}"><i class="fa fa-check"></i></div>'.format(row.ROW,opt.checked[row.ROW]?' dg-checked':''));for(var j=0;j<opt.cols.length;j++){var col=opt.cols[j];if(!col.hidden)column+=Tcol.format(j,col.template(row),col.align,row.CHANGES&&row.CHANGES[col.name]?' dg-col-changed':'')}column+='<div class="dg-col">&nbsp;</div>';var rowcustomclass=opt.rowclasstemplate?opt.rowclasstemplate(row):'';return Trow.format(index+1,column,index,self.selected===row?' dg-selected':'',(row.CHANGES?' dg-row-changed':'')+(rowcustomclass||''))};self.renderrows=function(rows,noscroll){opt.rows=rows;controls.cache={};var output=[],plus=0;if(config.exec){var val=self.get();plus=(val.page-1)*val.limit}var is=false;for(var i=0,length=rows.length;i<length;i++){var row=rows[i];if(!is&&self.selected){if(self.selected===row){is=true}else if(config.clickid&&self.selected[config.clickid]===row[config.clickid]){self.selected=row;is=true}}output.push(self.renderrow(i,rows[i],plus))}var min=((((opt.height||config.minheight)-120)/config.rowheight)>>0)+1;var is=output.length<min;if(is){for(var i=output.length;i<min+1;i++)output.push('<div class="dg-row-empty">&nbsp;</div>')}self.tclass('dg-noscroll',is);if(noscroll){self.scrollbarX.scrollLeft(0);self.scrollbarY&&self.scrollbarY.scrollTop(0)}opt.render=output;self.onrenderrows&&self.onrenderrows(opt)};self.exportrows=function(page_from,pages_count,callback,reset_page_to,sleep){var arr=[],source=self.get();if(reset_page_to===true)reset_page_to=source.page;if(page_from===true)reset_page_to=source.page;pages_count=page_from+pages_count;if(pages_count>source.pages)pages_count=source.pages;for(var i=page_from;i<pages_count;i++)arr.push(i);!arr.length&&arr.push(page_from);var index=0,rows=[];arr.wait(function(page,next){opt.scroll=(index++)===0?'xy':'';self.get().page=page;self.operation('page');self.onrenderrows=function(opt){rows.push.apply(rows,opt.rows);setTimeout(next,sleep||100)}},function(){self.onrenderrows=null;callback(rows,opt);if(reset_page_to>0){self.get().page=reset_page_to;self.operation('page')}})};self.reordercolumn=function(index,position){var col=opt.cols[index];if(!col)return;var old=col.index;opt.cols[index].index=position+(old<position?0.2:-0.2);opt.cols.quicksort('index');for(var i=0;i<opt.cols.length;i++){col=opt.cols[i];col.index=i}opt.cols.quicksort('index');self.rebindcss();self.rendercols();self.renderrows(opt.rows);opt.sort&&opt.sort.sort&&self.redrawsorting();opt.cluster&&opt.cluster.update(opt.render,true);self.scrolling();controls.hide();config.remember&&self.save()};self.resizecolumn=function(index,size){opt.cols[index].width=size;self.rebindcss();config.remember&&self.save();self.resize()};self.save=function(){var cache={};for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];col.index=i;cache[col.realindex]={index:col.index,width:col.width,hidden:col.hidden}}if(W.PREF)W.PREF.set(self.gridid,cache,'1 month');else CACHE(self.gridid,cache,'1 month')};self.rows=function(){return opt.rows.slice(0)};var resizecache={};self.resize=function(){setTimeout2(self.ID+'resize',self.resizeforce,100)};self.resizeforce=function(){if(!opt.cols||HIDDEN(self.dom)){resizecache.timeout&&clearTimeout(resizecache.timeout);resizecache.timeout=setTimeout(self.resizeforce,ready?1000:400);return}if(resizecache.timeout){clearTimeout(resizecache.timeout);resizecache.timeout=null}var el,footerh=opt.footer=footer.length?footer.height():0;if(typeof(config.height)==='string'&&config.height.substring(0,6)==='parent'){el=self.element.parent();var count=+config.height.substring(6);if(count){for(var i=0;i<count;i++)el=el.parent()}opt.height=(el.height()-config.margin)}else{switch(config.height){case'auto':var wh=config.parent?self.parent(config.parent).height():WH;el=self.element;opt.height=(wh-(el.offset().top+config.margin));break;case'window':opt.height=WH-config.margin;break;case'fluid':opt.height=((opt.rows?opt.rows.length:0)*config.rowheight)+header.outerHeight()+6;break;default:if(config.height>0){opt.height=config.height}else{el=self.element.closest(config.height);opt.height=((el.length?el.height():200)-config.margin)}break}}var mr=(vbody.parent().css('margin-right')||'').parseInt();var h=opt.height-footerh,sh=SCROLLBARWIDTH();controls.hide();if(config.height==='fluid'){var mh=config.minheight;if(h<mh)h=mh}else if(config.height==='auto'){var mh=config.minheight;if(h<mh)h=mh}var ismobile=isMOBILE&&isTOUCH;if(resizecache.mobile!==ismobile&&!config.noborder){resizecache.mobile=ismobile;self.tclass('dg-mobile',ismobile)}if(resizecache.h!==h){resizecache.h=h;sheader.css('height',h)}var tmpsh=h-(sh?(sh+self.scrollbarX.thinknessX-2):(footerh-2));resizecache.tmpsh=h;sbody.css('height',tmpsh+self.scrollbarX.marginY+(config.exec&&self.scrollbarX.size.empty?footerh:0));var w;if(config.fullwidth_xs&&WIDTH()==='xs'&&isMOBILE){var isfrm=false;try{isfrm=W.self!==W.top}catch(e){isfrm=true}if(isfrm){w=screen.width-(self.element.offset().left*2);if(resizecache.wmd!==w){resizecache.wmd=w;self.css('width',w)}}}if(w==null)w=self.width();var emptyspace=50-mr;if(emptyspace<50)emptyspace=50;var width=(config.numbering!==false?40:0)+(config.checkbox?40:0)+emptyspace;for(var i=0;i<opt.cols.length;i++){var col=opt.cols[i];if(!col.hidden)width+=col.width+1}if(w>width)width=w-2;if(resizecache.hc!==h){resizecache.hc=h;container.css('height',h)}if(resizecache.width!==width){resizecache.width=width;header.css('width',width);vbody.css('width',width);sbody.css('width',width);opt.width2=w}opt.height=h+footerh;self.scrollbarX.resize();self.scrollbarY&&self.scrollbarY.resize();ready=true;};self.refreshfilter=function(useraction){var obj=self.get()||EMPTYARRAY;var items=(obj instanceof Array?obj:obj.items)||EMPTYARRAY;var output=[];if(isredraw){if(isredraw===2){self.fn_in_checked();self.fn_in_changed()}}else{opt.checked={};config.checkbox&&header.find('.dg-checkbox-main').rclass('dg-checked');self.fn_in_checked(EMPTYARRAY)}for(var i=0;i<items.length;i++){var item=items[i];item.ROW=i;if(!config.exec){if(opt.filter&&!self.filter(item))continue;if(opt.search){for(var j=0;j<opt.cols.length;j++){var col=opt.cols[j];if(col.search)item['$'+col.name]=col.search(item)}}}output.push(item)}if(!isredraw){if(opt.scroll){if(self.scrollbarY&&(/y/).test(opt.scroll))self.scrollbarY.scrollTop(0);if((/x/).test(opt.scroll)){if(useraction){var sl=self.scrollbarX.scrollLeft();self.scrollbarX.scrollLeft(sl?sl-1:0)}else self.scrollbarX.scrollLeft(0)}opt.scroll=''}if(opt.sort!=null){if(!config.exec)opt.sort.sort&&output.quicksort(opt.sort.name,opt.sort.sort===1);self.redrawsorting()}}self.resize();self.renderrows(output,isredraw);setTimeout(self.resize,100);opt.cluster&&opt.cluster.update(opt.render,!opt.scroll||opt.scroll==='-');self.scrolling();if(isredraw){if(isredraw===2){self.select(self.selected||null)}}else{var sel=self.selected;if(config.autoselect&&output&&output.length){setTimeout(function(){var index=sel?output.indexOf(sel):0;if(index===-1)index=0;self.select(output[index])},1)}else{var index=sel?output.indexOf(sel):-1;self.select(index===-1?null:output[index])}}};self.redrawsorting=function(){var arr=self.find('.dg-sorting');for(var i=0;i<arr.length;i++){var el=$(arr[i]);var col=opt.cols[+el.attrd('index')];if(col){var fa=el.find('.dg-sort').rclass2('fa-');switch(col.sort){case 1:fa.aclass('fa-arrow-up');break;case 2:fa.aclass('fa-arrow-down');break;default:fa.aclass('fa-sort');break}}}controls.hide()};self.resetcolumns=function(){if(W.PREF)W.PREF.set(self.gridid);else CACHE(self.gridid,null,'-1 day');self.rebind(opt.declaration);self.cols(NOOP);ecolumns.aclass('hidden');isecolumns=false;controls.hide()};self.resetfilter=function(){opt.filter={};opt.filtercache={};opt.filtercl={};opt.filtervalues={};opt.cols&&self.rendercols();if(config.exec)self.operation('refresh');else self.refresh();controls.hide()};var pagecache={pages:-1,count:-1};self.redrawpagination=function(){if(!config.exec)return;var value=self.get();if(!value.page)value.page=1;if(value.pages==null)value.pages=0;if(value.count==null)value.count=0;var is=false;if(value.page===1||(value.pages!=null&&value.count!=null)){pagecache.pages=value.pages;pagecache.count=value.count;is=true}footer.find('button').each(function(){var el=$(this);var dis=true;switch(this.name){case'page-next':dis=value.page>=pagecache.pages;break;case'page-prev':dis=value.page===1;break;case'page-last':dis=!value.page||value.page>=pagecache.pages;break;case'page-first':dis=value.page===1;break}el.prop('disabled',dis)});footer.find('input')[0].value=value.page;if(is){var num=pagecache.pages||0;footer.find('.dg-pagination-pages')[0].innerHTML=num.pluralize.apply(num,config.pluralizepages);num=pagecache.count||0;footer.find('.dg-pagination-items')[0].innerHTML=num.pluralize.apply(num,config.pluralizeitems)}footer.rclass('hidden')};self.setter=function(value,path,type){if(!ready){setTimeout(self.setter,100,value,path,type);return}controls.hide();if(config.exec&&(value==null||value.items==null)){self.operation('refresh');if(value&&value.items==null)value.items=[];else return}if(value&&value.schema&&schemas.$current!==value.schema){schemas.$current=value.schema;self.selected=null;self.rebind(schemas[value.schema],true);setTimeout(function(){self.setter(value,path,type)},100);return}if(!opt.cols)return;opt.checked={};if(forcescroll){opt.scroll=forcescroll;forcescroll=''}else opt.scroll=type!=='noscroll'?'xy':'';self.applycolumns();self.refreshfilter();self.redrawsorting();self.redrawpagination();self.fn_in_changed();!config.exec&&self.rendercols();setTimeout2(self.ID+'resize',self.resize,100);if(opt.cluster)return;config.exec&&self.rendercols();opt.cluster=new Cluster(vbody);opt.cluster.grid=self;opt.cluster.scroll=self.scrolling;opt.render&&opt.cluster.update(opt.render);self.aclass('dg-visible')};self.scrolling=function(){config.checkbox&&setTimeout2(self.ID,function(){vbody.find('.dg-checkbox-main').each(function(){$(this).tclass('dg-checked',opt.checked[this.getAttribute('data-value')]==1)})},80,10)};var REG_STRING=/\/\|\\|,/,REG_DATE1=/\s-\s/,REG_DATE2=/\/|\||\\|,/,REG_SPACE=/\s/g;self.filter=function(row){var keys=Object.keys(opt.filter);for(var i=0;i<keys.length;i++){var column=keys[i],filter=opt.filter[column],val2=opt.filtercache[column],val=row['$'+column]||row[column],type=typeof(val);if(val instanceof Array){val=val.join(' ');type='string'}else if(val&&type==='object'&&!(val instanceof Date)){val=JSON.stringify(val);type='string'}if(type==='number'){if(val2==null)val2=opt.filtercache[column]=typeof(filter)==='number'?[filter]:self.parseNumber(filter+'');if(val2.length===1&&val!==val2[0])return false;if(val<val2[0]||val>val2[1])return false}else if(type==='string'){var is=false;if(opt.filtercl[column]!=null){is=opt.filtercl[column]==val;if(!is)return false}var col=opt.colsfilter[column];if(val2==null){val2=opt.filtercache[column]=filter.split(REG_STRING).trim();if(!col.filtertype){for(var j=0;j<val2.length;j++)val2[j]=val2[j].toSearch()}}var s=col.filtertype?val:val.toSearch();for(var j=0;j<val2.length;j++){if(s.indexOf(val2[j])!==-1){is=true;break}}if(!is)return false}else if(type==='boolean'){if(val2==null)val2=opt.filtercache[column]=typeof(filter)==='string'?config.boolean.indexOf(filter.replace(REG_SPACE,''))!==-1:filter;if(val2!==val)return false}else if(val instanceof Date){val.setHours(0);val.setMinutes(0);if(val2==null){val2=filter.trim().replace(REG_DATE1,'/').split(REG_DATE2).trim();var arr=opt.filtercache[column]=[];for(var j=0;j<val2.length;j++){var dt=val2[j].trim();var a=self.parseDate(dt,j===1);if(a instanceof Array){if(val2.length===2){arr.push(j?a[1]:a[0])}else{arr.push(a[0]);if(j===val2.length-1){arr.push(a[1]);break}}}else arr.push(a)}if(val2.length===2&&arr.length===2){arr[1].setHours(23);arr[1].setMinutes(59);arr[1].setSeconds(59)}val2=arr}if(val2.length===1){if(val2[0].YYYYMM)return val.format('yyyyMM')===val2[0].format('yyyyMM');if(val.format('yyyyMMdd')!==val2[0].format('yyyyMMdd'))return false}if(val<val2[0]||val>val2[1])return false}else return false}return true};self.checked=function(){var arr=Object.keys(opt.checked);var output=[],model=self.get()||EMPTYARRAY;var rows=model instanceof Array?model:model.items;for(var i=0;i<arr.length;i++){var index=+arr[i];output.push(rows[index])}return output};self.readfilter=function(){return opt.filter};self.changed=function(){var output=[],model=self.get()||EMPTYARRAY;var rows=model instanceof Array?model:model.items;for(var i=0;i<rows.length;i++)rows[i].CHANGES&&output.push(rows[i]);return output};self.parseDate=function(val,second){var index=val.indexOf('.');var m,y,d,a,special,tmp;if(index===-1){if((/[a-z]+/).test(val)){var dt;try{dt=NOW.add(val)}catch(e){return[0,0]}return dt>NOW?[NOW,dt]:[dt,NOW]}if(val.length===4)return[new Date(+val,0,1),new Date(+val+1,0,1)]}else if(val.indexOf('.',index+1)===-1){a=val.split('.');if(a[1].length===4){y=+a[1];m=+a[0]-1;d=second?new Date(y,m,0).getDate():1;special=true}else{y=NOW.getFullYear();m=+a[1]-1;d=+a[0]}tmp=new Date(y,m,d);if(special)tmp.YYYYMM=true;return tmp}index=val.indexOf('-');if(index!==-1&&val.indexOf('-',index+1)===-1){a=val.split('-');if(a[0].length===4){y=+a[0];m=+a[1]-1;d=second?new Date(y,m,0).getDate():1;special=true}else{y=NOW.getFullYear();m=+a[0]-1;d=+a[1]}tmp=new Date(y,m,d);if(special)tmp.YYYYMM=true;return tmp}return val.parseDate()};var REG_NUM1=/\s-\s/,REG_COMMA=/,/g,REG_NUM2=/\/|\|\s-\s|\\/;self.parseNumber=function(val){var arr=[],num=val.replace(REG_NUM1,'/').replace(REG_SPACE,'').replace(REG_COMMA,'.').split(REG_NUM2).trim();for(var i=0,length=num.length;i<length;i++){var n=num[i];arr.push(+n)}return arr};self.datagrid_cancel=function(meta,force){var current=self.editable;if(current&&current.is){current.is=false;force&&current.el.replaceWith(current.backup);current.input&&current.input.off();$(W).off('keydown',current.fn).off('click',current.fn)}};self.datagrid_edit=function(meta,next){if(!meta||!meta.col.editable)return;if(!self.editable)self.editable={};var el=meta.elcol,current=self.editable;current.is&&self.datagrid_cancel(meta,true);current.is=true;current.backup=el.find('.dg-editable').aclass('dg-editable').clone();el=el.find('.dg-editable');if(!meta.col.type){if(meta.value instanceof Date)meta.col.type='date';else meta.col.type=typeof(meta.value)}if(typeof(meta.col.editable)==='string'){meta.next=function(value){if(value!==undefined)meta.value=value;next(meta);self.datagrid_cancel(meta)};meta.cancel=function(){self.datagrid_cancel(meta)};self.EXEC(meta.col.editable,meta);return}if(meta.col.options){current.el=el;var opt={};opt.element=el;opt.items=meta.col.options;if(typeof(opt.items)==='string')opt.items=self.makepath(opt.items);opt.key=meta.col.otext;opt.placeholder=meta.col.dirsearch?meta.col.dirsearch:'';if(meta.col.dirsearch===false)opt.search=false;opt.callback=function(item){current.is=false;meta.value=item[meta.col.ovalue];next(meta);self.datagrid_cancel(meta)};SETTER('directory','show',opt);return}var align=meta.col.align;el.rclass('dg-value').html(meta.col.type.substring(0,4)==='bool'?'<div{1}><div class="dg-checkbox{0}" data-custom="2"><i class="fa fa-check"></i></div></div>'.format(meta.value?' dg-checked':'',align?(' class="'+align.trim()+'"'):''):'<input type="{0}" maxlength="{1}"{2} />'.format(meta.col.ispassword?'password':'text',meta.col.maxlength||100,align?(' class="'+align.trim()+'"'):''));current.el=el;var input=meta.elcol.find('input');input.val(meta.value instanceof Date?meta.value.format(meta.col.format):meta.value);input.focus();current.input=input;if(meta.col.type==='date'){var opt={};opt.element=el;opt.value=meta.value;opt.callback=function(date){current.is=false;meta.value=date;next(meta);self.datagrid_cancel(meta)};SETTER('datepicker','show',opt)}current.fn=function(e){if(!current.is)return;if(e.type==='click'){if(e.target.tagName==='INPUT')return;e.preventDefault();e.keyCode=13;if(meta.col.type==='date'){e.type='keydown';setTimeout(current.fn,800,e);return}else if(meta.col.type.substring(0,4)==='bool'){var tmp=$(e.target);var is=tmp.hclass('dg-checkbox');if(!is){tmp=tmp.closest('.dg-checkbox');is=tmp.length}if(is){meta.value=tmp.hclass('dg-checked');next(meta);self.datagrid_cancel(meta);return}}}switch(e.keyCode){case 13:case 9:var val=input.val();if(val==meta.value){next=null;self.datagrid_cancel(meta,true)}else{if(meta.col.type==='number'){val=val.parseFloat();if(val==meta.value||(meta.min!=null&&meta.min>val)||(meta.max!=null&&meta.max<val)){next=null;self.datagrid_cancel(meta,true);return}}else if(meta.col.type==='date'){val=val.parseDate(meta.format?meta.format.env():undefined);if(!val||isNaN(val.getTime()))val=null;if(val&&meta.value&&val.getTime()===meta.value.getTime()){next=null;self.datagrid_cancel(meta,true);return}}if(meta.col.required&&(val==null||val==='')){self.datagrid_cancel(meta,true);return}meta.value=val;next(meta);self.datagrid_cancel(meta)}if(e.which===9){var elcol=meta.elcol;while(true){elcol=elcol.next();if(!elcol.length)break;var eledit=elcol.find('.dg-editable');if(eledit.length){setTimeout(function(meta,elcol){self.editcolumn(meta.rowindex,+elcol.attr('class').match(/\d+/)[0])},200,meta,elcol);break}}}break;case 27:next=null;self.datagrid_cancel(meta,true);break}};$(W).on('keydown',current.fn).on('click',current.fn)}});
// End: j-DataGrid

// Component: j-InputTags
// Version: 1
// Updated: 2021-10-03 15:14
COMPONENT('inputtags','dirkey:name;dirvalue:id;transform:0;enteronly:1;after:\\:',function(self,config){var cls='ui-inputtags',cls2='.'+cls,input,placeholder,dirsource,binded,customvalidator,tags,skip=false;self.nocompile();self.bindvisible(50);self.init=function(){Thelpers.ui_inputtags_icon=function(val){return val.charAt(0)==='!'?('<span class="ui-inputtags-icon-custom">'+val.substring(1)+'</span>'):('<i class="fa fa-'+val+'"></i>')};W.ui_inputtags_template=Tangular.compile(('{{ if label}}<div class="{0}-label">{{ if icon}}<i class="fa fa-{{ icon}}"></i>{{ fi}}{{ label}}{{ after}}</div>{{ fi}}<div class="{0}-control{{ if dirsource}} {0}-dropdown{{ fi}}{{ if licon}} {0}-licon{{ fi}}{{ if ricon}} {0}-ricon{{ fi}}">{{ if ricon}}<div class="{0}-icon-right">{{ ricon | ui_inputtags_icon}}</div>{{ fi}}{{ if licon}}<div class="{0}-icon-left{{ if liconclick}} {0}-click{{ fi}}">{{ licon | ui_inputtags_icon}}</div>{{ fi}}<div class="{0}-input{{ if align === 1 || align === \'center\' }} center{{ else if align === 2 || align === \'right\' }} right{{ fi}}">{{ if placeholder && !innerlabel}}<div class="{0}-placeholder">{{ placeholder}}</div>{{ fi}}<div class="{0}-tags"><span class="{0}-editable" contenteditable="true"></span></div></div></div>{{ if error}}<div class="{0}-error hidden"><i class="fa fa-warning"></i> {{ error}}</div>{{ fi}}').format(cls))};self.make=function(){if(!config.label)config.label=self.html();if(isMOBILE&&config.autofocus)config.autofocus=false;config.PATH=self.path.replace(/\./g,'_');self.aclass(cls+' invisible');self.rclass('invisible',100);self.redraw();self.event('input change focusout',function(e){self.check();if(!config.enteronly&&e.type==='focusout'){setTimeout(function(){var val=input.text();val&&self.appendval(val);input.html('')},100)}});self.event('focus',cls2+'-editable',function(){self.aclass(cls+'-focused');config.autocomplete&&EXEC(config.autocomplete,self,input.parent());if(config.autosource){var opt={};opt.element=self.element;opt.search=GET(self.makepath(config.autosource));opt.callback=function(value){input.empty();self.appendval(typeof(value)==='string'?value:value[config.autovalue]);self.check()};SETTER('autocomplete','show',opt)}});self.event('blur',cls2+'-editable',function(){self.rclass(cls+'-focused')});self.event('click','.fa-times',function(e){var index=$(this).parent().index();self.removetag(index);e.stopPropagation();e.preventDefault()});self.event('click',cls2+'-tag',function(e){e.stopPropagation();e.preventDefault()});self.findvalue=function(arr,val){for(var i=0;i<arr.length;i++){if(arr[i]&&(arr[i]===val||arr[i][config.value]===val))return arr[i]}};self.event('click',cls2+'-control',function(){if(!config.dirsource||config.disabled)return;var opt={};opt.element=self.find(cls2+'-control');opt.items=dirsource;opt.offsetY=-1;opt.placeholder=config.dirplaceholder;opt.render=config.dirrender?GET(self.makepath(config.dirrender)):null;opt.custom=!!config.dircustom;opt.offsetWidth=2;opt.minwidth=config.dirminwidth||200;opt.maxwidth=config.dirmaxwidth;opt.key=config.dirkey||config.key;opt.empty=config.dirempty;if(config.dirvalue&&typeof(dirsource)!=='function'){var val=self.get()||EMPTYARRAY;opt.exclude=function(item){return item?typeof(item)==='string'?self.findvalue(val,item):self.findvalue(val,item[config.dirvalue]):false}}opt.callback=function(item,el,custom){if(item==null||(custom&&!opt.custom))return;var val=custom||(typeof(item)==='string'?item:item[config.dirvalue||config.value]);if(custom){if(typeof(config.dircustom)==='string'){var fn=GET(self.makepath(config.dircustom));fn(val,function(val){self.appendval(val,true)})}else self.appendval(item,true)}else if(!custom)self.appendval(typeof(dirsource)==='function'?item:val)};SETTER('directory','show',opt)});self.event('click',cls2+'-placeholder,'+cls2+'-label,'+cls2+'-input',function(e){if(!config.disabled){if(config.dirsource){e.preventDefault();e.stopPropagation();self.element.find(cls2+'-control').trigger('click')}else input.focus()}});self.event('click',cls2+'-icon-left,'+cls2+'-icon-right',function(e){if(config.disabled)return;var el=$(this);var left=el.hclass(cls+'-icon-left');if(config.dirsource&&left&&config.liconclick){e.preventDefault();e.stopPropagation()}if(left&&config.liconclick)EXEC(self.makepath(config.liconclick),self,el);else if(config.riconclick)EXEC(self.makepath(config.riconclick),self,el)})};self.curpos=function(pos){var el=input[0];if(el.createTextRange){var range=el.createTextRange();range.move('character',pos);range.select()}else if(el.selectionStart){el.focus();el.setSelectionRange(pos,pos)}};self.validate=function(value){if(!config.required||config.disabled)return true;if(config.dirsource)return!!value;if(customvalidator)return customvalidator(value);if(value==null)value=EMPTYARRAY;return value.length>0};self.offset=function(){var offset=self.element.offset();var control=self.find(cls2+'-control');var width=control.width()+2;return{left:offset.left,top:control.offset().top+control.height(),width:width}};self.setter=function(){if(skip)skip=false;else self.bindvalue()};self.appendval=function(value,custom){var cur=self.get()||EMPTYARRAY;var is=false,isfn=false,rawvalue=value;if(dirsource&&typeof(dirsource)==='function'){isfn=true;rawvalue=value[config.dirvalue];if(cur.indexOf(rawvalue)!==-1||!self.checkvalue(rawvalue))return}else{rawvalue=self.transform(rawvalue);if(cur.indexOf(rawvalue)!==-1||!self.checkvalue(rawvalue))return}if(config.dirsource){if(custom){is=true;self.appendtag(rawvalue)}else{if(isfn){is=true;self.appendtag(value[config.dirkey])}else{var item=dirsource.findItem(config.dirvalue,rawvalue);if(item){is=true;self.appendtag(item[config.dirkey])}}}}else{is=true;self.appendtag(rawvalue)}if(is){skip=true;self.push(rawvalue);self.change(true)}self.check();self.dirinitchecksum=0};self.appendtag=function(text){input.before('<span class="{0}-tag"><i class="fa fa-times"></i>{1}</span>'.format(cls,Thelpers.encode(text)))};self.removetag=function(index){skip=true;tags.find('span').eq(index).remove();self.get().splice(index,1);self.update(true);self.change(true);self.check()};self.checkvalue=function(val){return config.check?GET(self.makepath(config.check))(val):true};self.check=function(){var is=!!input[0].innerHTML||(self.get()||EMPTYARRAY).length>0;setTimeout(self.resize,10);if(binded===is)return;binded=is;placeholder&&placeholder.tclass('hidden',is);self.tclass(cls+'-binded',is);if(config.type==='search')self.find(cls2+'-icon-right').find('i').tclass(config.ricon,!is).tclass('fa-times',is)};self.dirinitchecksum=0;self.bindvalue=function(){var value=self.get()||EMPTYARRAY;var tmp=HASH(value);if(tmp===self.dirinitchecksum)return;self.dirinitchecksum=tmp;tags.find(cls2+'-tag').remove();if(dirsource){if(typeof(dirsource)==='function'){EXEC(self.makepath(config.dirinit),value,function(dirsource){var item;for(var i=0;i<dirsource.length;i++){item=dirsource[i];item.name=self.transform(item.name);if(value.indexOf(item[config.dirvalue||config.value])!=-1)self.appendtag(item[config.dirkey||config.key])}input.empty();self.check()});return}var arr=[],item;for(var i=0;i<dirsource.length;i++){item=dirsource[i];item.name=self.transform(item.name);if(typeof(item)==='string'){if(value.indexOf(item)===-1)continue;arr.push(item)}else if(value.indexOf(item[config.dirvalue||config.value])!=-1)arr.push(item[config.dirkey||config.key])}for(var i=0;i<arr.length;i++){item=arr[i];item&&self.appendtag(item)}}else{for(var i=0;i<value.length;i++){value[i]=self.transform(value[i]);value[i]&&self.appendtag(value[i])}}input.empty();self.check()};self.resize=function(){var h=self.find(cls2+'-input').innerHeight()+'px';self.find('.{0}-icon-right,.{0}-icon-left'.format(cls)).css({height:h,'line-height':h})};self.redraw=function(){if(!config.ricon){if(config.dirsource)config.ricon='angle-down'}self.html(W.ui_inputtags_template(config));input=self.find(cls2+'-editable');tags=self.find(cls2+'-tags');placeholder=self.find(cls2+'-placeholder');input.on('paste',function(e){e.preventDefault();e.stopPropagation();var text=e.originalEvent.clipboardData.getData(self.attrd('clipboard')||'text/plain');text&&document.execCommand('insertText',false,text)});input.on('keydown',function(e){var el;if(e.which===13){e.preventDefault();e.stopPropagation();el=$(this);setTimeout(function(){var val=el.text();val&&self.appendval(val);el.html('')},100)}else if(e.which===8){if(!this.innerHTML){var prev=$(this).prev();prev.length&&self.removetag(prev.index())}}})};self.configure=function(key,value){switch(key){case'dirsource':var tmp=GET(self.makepath(value));input.prop('contenteditable',!value);if(typeof(tmp)!=='function'){self.datasource(value,function(path,value){dirsource=value||EMPTYARRAY;self.bindvalue()})}else dirsource=tmp;break;case'disabled':self.tclass('ui-disabled',value==true);input.attr('contenteditable',!value);self.reset();break;case'required':self.tclass(cls+'-required',value==true);self.reset();break;case'validate':customvalidator=value?(/\(|=|>|<|\+|-|\)/).test(value)?FN('value=>'+value):(function(path){return function(value){return GET(path)(value)}})(value):null;break;case'innerlabel':self.tclass(cls+'-inner',value);break}};self.formatter(function(path,value){if(value){switch(config.type){case'lower':return value.toString().toLowerCase();case'upper':return value.toString().toUpperCase()}}return value});self.parser(function(path,value){if(value){switch(config.type){case'lower':value=value.toLowerCase();break;case'upper':value=value.toUpperCase();break}}return value?config.spaces===false?value.replace(/\s/g,''):value:value});self.state=function(type){if(!type)return;var invalid=config.required?self.isInvalid():false;if(invalid===self.$oldstate)return;self.$oldstate=invalid;self.tclass(cls+'-invalid',invalid);config.error&&self.find(cls2+'-error').tclass('hidden',!invalid)};self.transform=function(string){if(typeof string!=='string')return string;switch(config.transform){case 1:return string.toLowerCase();case 2:return string.toUpperCase();case 3:return self.capitalize(string)}return string};self.capitalize=function(string){return string.toLowerCase().replace(/(?:^|\s)\S/g,function(a){return a.toUpperCase()})}});
// End: j-InputTags

// Component: j-Box
// Version: 1
// Updated: 2022-01-12 21:15
COMPONENT('box','zindex:12;padding:25;scrollbar:1;scrolltop:1;style:1;align:center;background:1;transparent:0',function(self,config,cls){var cls2='.'+cls,csspos={},nav=false,init=false;if(!W.$$box){W.$$box_level=W.$$box_level||1;W.$$box=true;$(document).on('click',cls2+'-button-close',function(){SET($(this).attrd('path'),'')});var resize=function(){setTimeout2(self.name,function(){for(var i=0;i<M.components.length;i++){var com=M.components[i];if(com.name==='box'&&!HIDDEN(com.dom)&&com.$ready&&!com.$removed)com.resize()}},200)};ON('resize2',resize);$(document).on('click',cls2+'-container',function(e){if(e.target===this){var com=$(this).component();if(com&&com.config.closeoutside){com.set('');return}}var el=$(e.target);if(el.hclass(cls+'-container')&&el.hclass(cls+'-style-1')){var form=el.find(cls2);var c=cls+'-animate-click';form.aclass(c);setTimeout(function(){form.rclass(c)},300)}})}self.readonly();self.submit=function(){if(config.submit)self.EXEC(config.submit,self.hide,self.element);else self.hide()};self.cancel=function(){config.cancel&&self.EXEC(config.cancel,self.hide);self.hide()};self.hide=function(){if(config.independent)self.hideforce();self.set('')};self.icon=function(value){var el=this.rclass2('fa');if(value.icon)el.aclass(self.faicon(value.icon)).rclass('hidden');else el.aclass('hidden')};self.resize=function(){if(self.hclass('hidden'))return;var padding=isMOBILE||WIDTH()==='xs'?0:config.padding;var ui=self.find(cls2);csspos.height=WH-(config.style==1?(padding*2):padding);csspos.top=config.style===3?0:padding;ui.css(csspos);var el=self.find(cls2+'-title');var th=el.height();var w=ui.width();if(w>WW)w=WW;csspos={height:csspos.height-th,width:w};if(nav)csspos.height-=nav.height()+5;self.find(cls2+'-body').css(csspos);self.scrollbar&&self.scrollbar.resize();self.element.SETTER('*','resize')};self.make=function(){var html='<div id="{0}" class="hidden {4}-container invisible{6}"><div class="{4}{5}"{1}><div data-bind="@config__text .{4}-label:value.title__exec .{4}-icon:@icon" class="{4}-title"><button name="cancel" class="{4}-button-close{3}" data-path="{2}"><i class="fa fa-times"></i></button><i class="{4}-icon"></i><span class="{4}-label"></span></div><div class="{4}-body"></div></div>'.format(self.ID,config.width?(' style="max-width:'+config.width+'px"'):'',self.path,config.closebutton==false?' hidden':'',cls,config.align==='center'?'':(' '+cls+'-align-'+config.align),' '+cls+'-'+(config.background?'':'no')+'bg');$(document.body).append(html);var scr=self.find('> script');self.template=scr.length?scr.html().trim():'';scr.length&&scr.remove();var el=$('#'+self.ID);var body=el.find(cls2+'-body')[0];var counter=0;el.css('padding','0 '+config.padding+'px');while(self.dom.children.length){var child=self.dom.children[0];if(child.tagName==='NAV'){nav=$(child);if(counter)body.parentNode.appendChild(child);else el.find(cls2+'-title')[0].appendChild(child)}else body.appendChild(child);counter++}self.rclass('hidden invisible');self.replace(el,true);if(config.scrollbar)self.scrollbar=SCROLLBAR(self.find(cls2+'-body'),{shadow:config.scrollbarshadow,visibleY:config.visibleY,orientation:'y'});self.aclass(cls+'-style-'+config.style);if(config.transparent)self.aclass(cls+'-transparent');self.event('scroll',function(){EMIT('scroll',self.name);EMIT('reflow',self.name)});self.event('click','button[name]',function(){var t=this;switch(t.name){case'submit':self.submit(self.hide);break;case'cancel':!t.disabled&&self[t.name](self.hide);break}});config.enter&&self.event('keydown','input',function(e){e.which===13&&!self.find('button[name="submit"]')[0].disabled&&setTimeout2(self.ID+'enter',self.submit,500)})};self.configure=function(key,value,init,prev){if(!init){switch(key){case'background':self.tclass(cls+'-bg',!!value);break;case'algin':self.rclass2(cls+'-align').aclass(cls+'–align-'+value);break;case'width':value!==prev&&self.find(cls2).css('max-width',value+'px');break;case'closebutton':self.find(cls2+'-button-close').tclass('hidden',value!==true);break}}};self.esc=function(bind){if(bind){if(!self.$esc){self.$esc=true;$(W).on('keydown',self.esc_keydown)}}else{if(self.$esc){self.$esc=false;$(W).off('keydown',self.esc_keydown)}}};self.esc_keydown=function(e){if(e.which===27&&!e.isPropagationStopped()){var val=self.get();if(!val||config.if===val){e.preventDefault();e.stopPropagation();self.hide()}}};self.hideforce=function(){if(!self.hclass('hidden')){self.aclass('hidden');self.release(true);self.esc(false);self.find(cls2).rclass(cls+'-animate');W.$$box_level--}};var allowscrollbars=function(){$('html').tclass(cls+'-noscroll',!!$(cls2+'-container').not('.hidden').length)};self.setter=function(value){setTimeout2(self.name+'-noscroll',allowscrollbars,50);var isHidden=value!==config.if;if(self.hclass('hidden')===isHidden){if(!isHidden){config.reload&&self.EXEC(config.reload,self);config.default&&DEFAULT(self.makepath(config.default),true);config.scrolltop&&self.scrollbar&&self.scrollbar.scrollTop(0)}return}setTimeout2(cls,function(){EMIT('reflow',self.name)},10);if(isHidden){if(!config.independent)self.hideforce();return}if(self.template){var is=self.template.COMPILABLE();self.find(cls2).append(self.template);self.template=null;is&&COMPILE()}if(W.$$box_level<1)W.$$box_level=1;W.$$box_level++;self.css('z-index',W.$$box_level*config.zindex);self.aclass('invisible');self.rclass('hidden');self.release(false);config.scrolltop&&self.scrollbar&&self.scrollbar.scrollTop(0);config.reload&&self.EXEC(config.reload,self);config.default&&DEFAULT(self.makepath(config.default),true);self.resize();setTimeout(function(){self.rclass('invisible');self.find(cls2).aclass(cls+'-animate');if(!init&&isMOBILE){$('body').aclass('hidden');setTimeout(function(){$('body').rclass('hidden')},50)}config.autofocus&&self.autofocus(config.autofocus);init=true},200);setTimeout2(self.ID,function(){self.css('z-index',(W.$$box_level*config.zindex)+1)},500);config.closeesc&&self.esc(true)}});
// End: j-Box

// Component: j-Directory
// Version: 1
// Updated: 2022-01-12 21:43
COMPONENT('directory','minwidth:200',function(self,config,cls){var cls2='.'+cls,container,timeout,icon,plus,skipreset=false,skipclear=false,ready=false,input=null,issearch=false,is=false,selectedindex=0,resultscount=0,skiphide=false,templateE='{{ name | encode | ui_directory_helper}}',templateR='{{ name | raw}}',template='<li data-index="{{ $.index}}" data-search="{{ $.search}}" {{ if selected}} class="current selected{{ if classname}} {{ classname}}{{ fi}}"{{ else if classname}} class="{{ classname}}"{{ fi}}>{{ if $.checkbox}}<span class="'+cls+'-checkbox"><i class="fa fa-check"></i></span>{{ fi}}{0}</li>',templateraw=template.format(templateR);var regstrip=/(&nbsp;|<([^>]+)>)/ig;var parentclass=null,main;template=template.format(templateE);Thelpers.ui_directory_helper=function(val){var t=this;return t.template?(typeof(t.template)==='string'?t.template.indexOf('{{')===-1?t.template:Tangular.render(t.template,this):t.render(this,val)):self.opt.render?self.opt.render(this,val):val};self.template=Tangular.compile(template);self.templateraw=Tangular.compile(templateraw);self.readonly();self.singleton();self.nocompile&&self.nocompile();self.configure=function(key,value,init){if(init)return;switch(key){case'placeholder':self.find('input').prop('placeholder',value);break}};self.make=function(){self.aclass('hidden '+cls+'-area');self.append('<div class="{1}"><div class="{1}-search"><span class="{1}-add hidden"><i class="fa fa-plus"></i></span><span class="{1}-button"><i class="fa fa-search"></i></span><div><input type="text" placeholder="{0}" class="{1}-search-input" name="dir{2}" autocomplete="new-password" /></div></div><div class="{1}-container"><ul></ul></div></div>'.format(config.placeholder,cls,Date.now()));main=self.find(cls2);container=self.find('ul');input=self.find('input');icon=self.find(cls2+'-button').find('.fa');plus=self.find(cls2+'-add');self.event('mouseenter mouseleave','li',function(){if(ready&&!issearch){container.find('li.current').rclass('current');$(this).aclass('current');var arr=container.find('li:visible');for(var i=0;i<arr.length;i++){if($(arr[i]).hclass('current')){selectedindex=i;break}}}});self.element.on('click',function(e){if(e.target===self.dom)self.hide(1)});self.event('focus','input',function(){if(self.opt.search===false)$(this).blur()});self.event('click',cls2+'-button',function(e){skipclear=false;input.val('');self.search();e.stopPropagation();e.preventDefault()});self.event('click',cls2+'-add',function(){if(self.opt.custom&&self.opt.callback){self.opt.scope&&M.scope(self.opt.scope);self.opt.callback(input.val(),self.opt.element,true);self.hide()}});self.event('click','li',function(e){if(self.opt.callback){self.opt.scope&&M.scope(self.opt.scope);var item=self.opt.items[+this.getAttribute('data-index')];if(self.opt.checkbox){item.selected=!item.selected;if(item.selected)item.selectedts=Date.now();else delete item.selectedts;$(this).tclass('selected',item.selected);if(self.opt.checked){var tmpindex=self.opt.checked.indexOf(item.id);if(item.selected){if(tmpindex===-1)self.opt.checked.push(item.id)}else if(tmpindex!==-1)self.opt.checked.splice(tmpindex,1)}var response=null;if(self.opt.checked){response=self.opt.checked.slice(0)}else{response=[];for(var i=0;i<self.opt.items.length;i++){var m=self.opt.items[i];if(m.selected)response.push(m)}}response.quicksort('selectedts');self.opt.callback(response,self.opt.element,false,e);skiphide=true}else self.opt.callback(item,self.opt.element,false,e)}is=true;if(!self.opt.checkbox){self.hide(0);e.preventDefault();e.stopPropagation()}});var e_click=function(e){if(skiphide){skiphide=false;return}var node=e.target,count=0;if(is){while(true){var c=node.getAttribute('class')||'';if(c.indexOf(cls+'-search-input')!==-1)return;node=node.parentNode;if(!node||!node.tagName||node.tagName==='BODY'||count>3)break;count++}}else{is=true;while(true){var c=node.getAttribute('class')||'';if(c.indexOf(cls)!==-1){is=false;break}node=node.parentNode;if(!node||!node.tagName||node.tagName==='BODY'||count>4)break;count++}}is&&self.hide(0)};var e_resize=function(){is&&self.hide(0)};self.bindedevents=false;self.bindevents=function(){if(!self.bindedevents){$(W).on('resize',e_resize);self.bindedevents=true}};self.unbindevents=function(){if(self.bindedevents){self.bindedevents=false;$(W).off('resize',e_resize)}};self.event('keydown','input',function(e){var o=false;switch(e.which){case 8:skipclear=false;break;case 27:o=true;self.hide();break;case 13:o=true;var sel=self.find('li.current');if(self.opt.callback){self.opt.scope&&M.scope(self.opt.scope);var index=+sel.attrd('index');if(self.opt.custom&&(!sel.length||index===-1))self.opt.callback(this.value,self.opt.element,true);else self.opt.callback(self.opt.items[index],self.opt.element)}self.hide();break;case 38:o=true;selectedindex--;if(selectedindex<0)selectedindex=0;self.move();break;case 40:o=true;selectedindex++;if(selectedindex>=resultscount)selectedindex=resultscount;self.move();break}if(o){e.preventDefault();e.stopPropagation()}});self.event('input','input',function(){issearch=true;setTimeout2(self.ID,self.search,100,null,this.value)});var fn=function(){is&&self.hide(1)};self.on('reflow + scroll + resize + resize2',fn);$(W).on('scroll',fn)};self.move=function(){var counter=0,scroller=container.parent();var li=container.find('li');var hli=0,was=false,last=-1,lastselected=0,plus=0;for(var i=0;i<li.length;i++){var el=$(li[i]);if(el.hclass('hidden')){el.rclass('current');continue}var is=selectedindex===counter;el.tclass('current',is);if(is){hli=(el.innerHeight()||30)+1;plus=(hli*2);was=true;var t=(hli*(counter||1));scroller[0].scrollTop=t-plus}counter++;last=i;lastselected++}if(!was&&last>=0){selectedindex=lastselected;li.eq(last).aclass('current')}};var nosearch=function(){issearch=false};self.nosearch=function(){setTimeout2(self.ID+'nosearch',nosearch,500)};self.search=function(value){if(!self.opt)return;icon.tclass('fa-times',!!value).tclass('fa-search',!value);self.opt.custom&&plus.tclass('hidden',!value);if(!value&&!self.opt.ajax){if(!skipclear)container.find('li').rclass('hidden');if(!skipreset)selectedindex=0;resultscount=self.opt.items?self.opt.items.length:0;self.move();self.nosearch();return}resultscount=0;selectedindex=0;if(self.opt.ajax){var val=value||'';if(self.ajaxold!==val){self.ajaxold=val;setTimeout2(self.ID,function(val){self.opt&&self.opt.ajax(val,function(items){var builder=[],indexer={},item,key=(self.opt.search==true?self.opt.key:(self.opt.search||self.opt.key))||'name';for(var i=0;i<items.length;i++){item=items[i];if(self.opt.exclude&&self.opt.exclude(item))continue;if(self.opt.checked)item.selected=self.opt.checked.indexOf(item.id)!==-1;indexer.index=i;indexer.search=item[key]?item[key].replace(regstrip,''):'';indexer.checkbox=self.opt.checkbox===true;resultscount++;builder.push(self.opt.ta(item,indexer))}if(self.opt.empty){item={};var tmp=self.opt.raw?'<b>{0}</b>'.format(self.opt.empty):self.opt.empty;item[self.opt.key||'name']=tmp;if(!self.opt.raw)item.template='<b>{0}</b>'.format(self.opt.empty);indexer.index=-1;builder.unshift(self.opt.ta(item,indexer))}skipclear=true;self.opt.items=items;container.html(builder);self.move();self.nosearch()})},300,null,val)}}else if(value){value=value.toSearch().split(' ');var arr=container.find('li');for(var i=0;i<arr.length;i++){var el=$(arr[i]);var val=el.attrd('search').toSearch();var is=false;for(var j=0;j<value.length;j++){if(val.indexOf(value[j])===-1){is=true;break}}el.tclass('hidden',is);if(!is)resultscount++}skipclear=true;self.move();self.nosearch()}};self.show=function(opt){if(opt.checked==true)opt.checked=[];var el=opt.element instanceof jQuery?opt.element[0]:opt.element;if(opt.items==null)opt.items=EMPTYARRAY;self.tclass(cls+'-default',!opt.render);if(parentclass){self.rclass(parentclass);parentclass=null}if(opt.classname){main.aclass(opt.classname);parentclass=opt.classname}if(!opt.minwidth)opt.minwidth=200;if(is){clearTimeout(timeout);if(self.target===el){self.hide(1);return}}self.initializing=true;self.target=el;opt.ajax=null;self.ajaxold=null;var element=$(opt.element);var callback=opt.callback,items=opt.items,type=typeof(items);var item;if(type==='string'){items=opt.items=GET(items);type=typeof(items)}if(type==='function'&&callback){type='';opt.ajax=items;items=null}if(!items&&!opt.ajax){self.hide(0);return}setTimeout(self.bindevents,500);self.tclass(cls+'-search-hidden',opt.search===false);self.opt=opt;opt.class&&main.aclass(opt.class);input.val('');var builder=[],selected=null;opt.ta=opt.key?Tangular.compile((opt.raw?templateraw:template).replace(/\{\{\sname/g,'{{ '+opt.key)):opt.raw?self.templateraw:self.template;if(!opt.ajax){var indexer={},key=(opt.search==true?opt.key:(opt.search||opt.key))||'name';for(var i=0;i<items.length;i++){item=items[i];if(typeof(item)==='string')item={name:item,id:item,selected:item===opt.selected};if(opt.exclude&&opt.exclude(item))continue;if(item.selected||opt.selected===item){selected=i;skipreset=true;item.selected=true}else item.selected=false;if(opt.checked&&item.selected)opt.checked.push(item.id);indexer.checkbox=opt.checkbox===true;indexer.index=i;indexer.search=item[key]?item[key].replace(regstrip,''):'';builder.push(opt.ta(item,indexer))}if(opt.empty){item={};var tmp=opt.raw?'<b>{0}</b>'.format(opt.empty):opt.empty;item[opt.key||'name']=tmp;if(!opt.raw)item.template='<b>{0}</b>'.format(opt.empty);indexer.index=-1;builder.unshift(opt.ta(item,indexer))}}self.target=element[0];var w=element.width();var offset=element.offset();var width=w+(opt.offsetWidth||0);if(opt.minwidth&&width<opt.minwidth)width=opt.minwidth;else if(opt.maxwidth&&width>opt.maxwidth)width=opt.maxwidth;ready=false;opt.ajaxold=null;plus.aclass('hidden');self.find('input').prop('placeholder',opt.placeholder||config.placeholder);var scroller=self.find(cls2+'-container').css('width',width+30);container.html(builder);var options={left:0,top:0,width:width};switch(opt.align){case'center':options.left=Math.ceil((offset.left-width/2)+(opt.element.innerWidth()/2));break;case'right':options.left=(offset.left-width)+opt.element.innerWidth();break;default:options.left=offset.left;break}options.top=opt.position==='bottom'?((offset.top-self.height())+element.height()):offset.top;options.scope=M.scope?M.scope():'';if(opt.offsetX)options.left+=opt.offsetX;if(opt.offsetY)options.top+=opt.offsetY;var mw=width,mh=self.height();if(options.left<0)options.left=10;else if((mw+options.left)>WW)options.left=(WW-mw)-10;var dom=opt.element[0].parentNode,restrict=true;while(dom){if(dom.tagName==='BODY'){restrict=false;break}if(dom.classList.contains('ui-scrollbar-area'))break;dom=dom.parentNode}if(options.top<0)options.top=10;else if(restrict&&(mh+options.top)>WH)options.top=(WH-mh)-10;main.css(options);!isMOBILE&&setTimeout(function(){ready=true;if(opt.search!==false)input.focus()},200);setTimeout(function(){self.initializing=false;is=true;if(selected==null)scroller[0].scrollTop=0;else{var h=container.find('li:first-child').innerHeight()+1;var y=(container.find('li.selected').index()*h)-(h*2);scroller[0].scrollTop=y<0?0:y}},100);if(is){self.search();return}selectedindex=selected||0;resultscount=items?items.length:0;skipclear=true;self.search();self.rclass('hidden');setTimeout(function(){if(self.opt&&self.target&&self.target.offsetParent)main.aclass(cls+'-visible');else self.hide(1)},100);skipreset=false};self.hide=function(sleep){if(!is||self.initializing)return;clearTimeout(timeout);timeout=setTimeout(function(){self.unbindevents();self.rclass(cls+'-visible').aclass('hidden');if(self.opt){self.opt.close&&self.opt.close();self.opt.class&&self.rclass(self.opt.class);self.opt=null}is=false},sleep?sleep:100)}});
// End: j-Directory